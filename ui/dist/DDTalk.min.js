// DDTalk - v20.01.9
// Author: DDP

"use strict";!function(options){var DDTalkVersionNumber="20.01.9";window.enableAdapter=!0;var connection=new RTCMultiConnection;connection.autoCloseEntireSession=!1,connection.socketURL="/",connection.enableLogs=DEBUG,DEBUG&&console.info("Version RTCMultiConnection: ",connection.version),connection.session={audio:!0,video:!0,data:!0};var roomid,mess="",statusBoxUI=document.getElementById("status-box"),statusContentUI=document.getElementById("status-content");function statusHeaderHandler(mess,interval,color){interval=interval||0,mess&&0!=mess.length?(document.fullscreenElement&&document.exitFullscreen(),statusContentUI.style.color=color||"black",statusContentUI.innerHTML=""+mess,statusBoxUI.style.display="",Resize(),interval>0?setTimeout(function(){statusContentUI.innerHTML="",statusBoxUI.style.display="none",mess="",Resize()},interval):Resize()):(statusContentUI.innerHTML="",statusBoxUI.style.display="none",Resize())}function randomString(){return(Math.random()*(new Date).getTime()).toString(36).replace(/\./g,"")}!function(){var params={},r=/([^&=]+)=?([^&]*)/g;function d(s){return decodeURIComponent(s.replace(/\+/g," "))}for(var match,search=window.location.search;match=r.exec(search.substring(1));)params[d(match[1])]=d(match[2]);window.params=params}(),1==("true"==params.cs)&&function(){localStorage.clear(),sessionStorage.clear();var rUrl=window.location.protocol+"//"+window.location.hostname+(window.location.port?":"+window.location.port:"")+window.location.pathname;window.location.href=rUrl}(),params.roomid&&(roomid=params.roomid.replace(/[^а-яА-ЯёЁA-Za-z0-9]+/g,"")),!roomid&&localStorage.getItem("roomid")?roomid=localStorage.getItem("roomid").replace(/[^а-яА-ЯёЁA-Za-z0-9]+/g,""):roomid||localStorage.getItem("roomid")||(roomid=randomString()+randomString()),document.getElementById("room-id").value=roomid,localStorage.setItem("roomid",roomid),document.getElementById("room-id").onkeyup=function(e){this.value=this.value.replace(/[^а-яА-ЯёЁA-Za-z0-9]+/g,""),this.value.length?document.getElementById("open-or-join-room").disabled=!1:document.getElementById("open-or-join-room").disabled=!0,this.value&&(localStorage.setItem("roomid",this.value),roomid=this.value,reSetRoomLinks(),0==connection.streamEvents.selectAll().length&&0==connection.getAllParticipants()||location.reload())},document.getElementById("ChangeRoomID").onclick=function(){roomid=document.getElementById("room-id").value=randomString()+randomString(),localStorage.setItem("roomid",roomid),reSetRoomLinks(),0==connection.streamEvents.selectAll().length&&0==connection.getAllParticipants()||location.reload()};var isView="true"===params.isview,isAdmin="true"===params.admin,autoStart="true"===params.autostart,soundOff="true"===params.soundoff;!0===soundOff&&(document.getElementById("sound-off").style.display=""),params.quality&&(params.quality=params.quality.replace(/[^а-яА-ЯёЁA-Za-z0-9]+/g,"")),params.bandwidth&&(params.bandwidth=params.bandwidth.replace(/[^а-яА-ЯёЁA-Za-z0-9]+/g,""));var enableViewers=!1;enableViewers="true"==localStorage.getItem("addViewers");var enableViewersHTML=document.getElementById("enableviewers"),viewersControlHTML=document.getElementById("viewers-control");function enableViewersHandler(){enableViewersHTML.checked=enableViewers,localStorage.setItem("addViewers",enableViewers),enableViewers||isAdmin?(viewersControlHTML.style.display="inline",document.getElementById("view-number-panel").style.display=""):(viewersControlHTML.style.display="none",document.getElementById("view-number-panel").style.display="none"),connection.streamEvents.selectAll().length>0&&Resize(),connection.extra.viewerEnableStatus=enableViewers,connection.extra.roomInitiator&&connection.updateExtraData(),connection.getAllParticipants().forEach(function(pid){!0!=!connection.extra.broadcaster&&!0!=!connection.peers[pid].extra.viewer&&(enableViewers||connection.disconnectWith(pid))})}enableViewersHTML.checked=enableViewers,enableViewersHTML.onchange=function(){enableViewers=this.checked,enableViewersHandler()};var enableAdmins="true"==localStorage.getItem("addAdmins"),enableAdminsHTML=document.getElementById("enable-admins"),adminsControlHTML=document.getElementById("admin-url");function enableAdminsHandler(){enableAdminsHTML.checked=enableAdmins,localStorage.setItem("addAdmins",enableAdmins),enableAdmins||isAdmin?(adminsControlHTML.style.display="inline",document.getElementById("admin-number-panel").style.display=""):(adminsControlHTML.style.display="none",document.getElementById("admin-number-panel").style.display="none"),connection.extra.adminEnableStatus=enableAdmins,connection.extra.roomInitiator&&connection.updateExtraData()}enableAdminsHTML.checked=enableAdmins,enableAdminsHTML.onchange=function(){enableAdmins=this.checked,enableAdminsHandler()};var webcamSwitchStatus=!1,webcamSwitch=document.getElementById("webcam"),webcamSwitchOff=document.getElementById("webcam-off");function webcamSwitchHandler(){cameraPermission?webcamSwitchStatus?(webcamSwitch.style.display="none",webcamSwitchOff.style.display="",selectStreamQuality.value="OFF",selectStreamQuality.onchange()):(webcamSwitch.style.display="",webcamSwitchOff.style.display="none",selectStreamQuality.value="NL",selectStreamQuality.onchange()):(webcamSwitch.style.display="none",webcamSwitchOff.style.display="")}webcamSwitch.onclick=function(){webcamSwitchStatus=!0,webcamSwitchHandler()},webcamSwitchOff.onclick=function(){webcamSwitchStatus=!1,webcamSwitchHandler()};var walkieTalkieModeEnable="true"==params.togglemic;walkieTalkieModeEnable="true"==sessionStorage.getItem("walkieTalkieModeEnable");var micHTML=document.getElementById("mic");micHTML.src=walkieTalkieModeEnable?"mic-off.png":"mic-on.png",micHTML.onclick=function(){walkieTalkieModeEnable=!walkieTalkieModeEnable,SpacebarToggleLocalMicrophone()};var spacebarPressed=!1;function SpacebarToggleLocalMicrophone(activate){walkieTalkieModeEnable?walkieTalkieModeEnable&&!activate?(micHTML.src="mic-off.png",connection.streamEvents.selectAll("local").length>0&&mute("audio")):walkieTalkieModeEnable&&activate&&(micHTML.src="mic-spacebar-toggle.png",connection.streamEvents.selectAll("local").length>0&&unmute("audio")):(micHTML.src="mic-on.png",connection.streamEvents.selectAll("local").length>0&&unmute("audio")),sessionStorage.setItem("walkieTalkieModeEnable",walkieTalkieModeEnable)}window.addEventListener("keydown",function(e){32==e.keyCode&&"input-text-chat"!=document.activeElement.id&&(SpacebarToggleLocalMicrophone(!0),spacebarPressed=!0)},!0),window.addEventListener("keyup",function(e){32==e.keyCode&&(e.preventDefault(),SpacebarToggleLocalMicrophone(!1),spacebarPressed=!1),27==e.keyCode&&(e.preventDefault(),function(){if(isView)return;"none"==document.getElementById("room-settings").style.display?document.getElementById("config").onclick():document.getElementById("stop-config").onclick()}(),"none"==document.getElementById("room-urls").style.display?document.getElementById("share-room-urls").onclick():document.getElementById("stop-share-room-urls").onclick())},!0);var isPassword=!1;function sanitizePassParams(v){return v&&v.length||(v=""),v.replace(/[^а-яА-ЯёЁA-Za-z0-9]+/g,"")}params.password?(isPassword=sanitizePassParams(params.password),document.getElementById("room-password").value=isPassword,document.getElementById("labelPassword").style.display=""):(document.getElementById("labelPassword").style.display="none",document.getElementById("room-password").value=""),document.getElementById("setPassword").onclick=function(){var password=prompt("Please enter room password");password&&password.length?(isPassword=sanitizePassParams(password),document.getElementById("room-password").value=isPassword,document.getElementById("labelPassword").style.display="",document.getElementById("setPassword").style.display="none"):password=""},document.getElementById("room-password").onkeyup=function(e){this.value=isPassword=sanitizePassParams(this.value)};var setParticipants=0,setMaxParticipants=17,MaxParticipantsNumber=document.getElementById("participants-number");function sanitizeIntParams(v){return v||(v="0"),v=v.replace(/[^0-9]+/g,"")||0}function setupURL(role,fullURL=!0,pushState=!1){var userLink=fullURL?window.location.protocol+"//"+window.location.hostname+(window.location.port?":"+window.location.port:"")+window.location.pathname:"";return userLink+=roomid?"?roomid="+roomid:"","broadcaster"===role?(userLink+="&ice="+isICETransport,userLink+=selectStreamQuality.value?"&quality="+selectStreamQuality.value:"",userLink+=selectBandwidth.value?"&bandwidth="+selectBandwidth.value:"",userLink+=document.getElementById("autostart-for-joner").checked?"&autostart=true":"",userLink+=soundOff?"&soundoff=true":""):"viewer"===role?(userLink+="&ice="+isICETransport,userLink+="&isview=true",userLink+=document.getElementById("soundoff").checked?"&soundoff=true":""):"admin"===role&&(userLink+="&admin=true"),pushState&&history.pushState&&window.history.pushState({"New settings":userLink},"DD Talk Change room settings",userLink),userLink}function changeURLinUI(htmlEl,url){var el=document.getElementById(htmlEl);el&&el.setAttribute("href",url)}function changeLinksInRoomUrlsPanel(role="all",fullURL=!0,pushState=!1){"broadcaster"!==role&&"all"!==role||changeURLinUI("share-url-for-join",setupURL("broadcaster",fullURL,pushState)),"viewer"!==role&&"all"!==role||changeURLinUI("share-url-for-view",setupURL("viewer",fullURL,pushState)),"admin"!==role&&"all"!==role||changeURLinUI("share-url-for-admin",setupURL("admin",fullURL,pushState))}function reSetRoomLinks(){isAdmin||isView||!params.quality?isAdmin&&changeLinksInRoomUrlsPanel("admin",!1,!0):(changeLinksInRoomUrlsPanel("broadcaster",!1,!0),changeLinksInRoomUrlsPanel("viewer",!1,!1)),changeLinksInRoomUrlsPanel()}function copyURL(str){str=document.getElementById(str).href;const el=document.createElement("textarea");el.value=str,document.body.appendChild(el),el.select();try{var msg=document.execCommand("copy")?"Successful ":"Unsuccessful ";DEBUG&&console.log("Copying command was "+msg),DEBUG&&console.log("URL: "+str),statusHeaderHandler(str=msg+" copy URL: "+str,3e3)}catch(err){DEBUG&&console.log("Oops, unable to copy")}document.body.removeChild(el)}MaxParticipantsNumber.max=setMaxParticipants,setParticipants=(setParticipants=params.num&&!sessionStorage.getItem("participantsNum")?params.num=sanitizeIntParams(params.num):sessionStorage.getItem("participantsNum")?sanitizeIntParams(sessionStorage.getItem("participantsNum")):setMaxParticipants)<=setMaxParticipants?setParticipants:setMaxParticipants,sessionStorage.setItem("participantsNum",setParticipants),MaxParticipantsNumber.value=setParticipants,MaxParticipantsNumber.max=setMaxParticipants,MaxParticipantsNumber.min=0,MaxParticipantsNumber.step=1,MaxParticipantsNumber.onkeyup=MaxParticipantsNumber.oninput=function(){this.value=setParticipants=sanitizeIntParams(this.value)<=setMaxParticipants?sanitizeIntParams(this.value):setMaxParticipants,sessionStorage.setItem("participantsNum",setParticipants)},document.getElementById("autostart-for-joner").onchange=function(){reSetRoomLinks()},document.getElementById("soundoff").onchange=function(){reSetRoomLinks()},document.getElementById("copy-join-url").onclick=function(e){copyURL("share-url-for-join")},document.getElementById("copy-view-url").onclick=function(e){copyURL("share-url-for-view")},document.getElementById("copy-admin-url").onclick=function(e){copyURL("share-url-for-admin")},document.getElementById("share-room-urls").onclick=function(){"none"==document.getElementById("stop-share-room-urls").style.display&&(document.getElementById("stop-share-room-urls").style.display="",document.getElementById("share-room-urls").style.display="none",document.getElementById("room-params").style.display="",document.getElementById("room-urls").style.display="",document.getElementById("viewers-control").style.display=1==enableViewers?"inline":"none",document.getElementById("admin-url").style.display=1==enableAdmins?"inline":"none",connection.streamEvents.selectAll().length>0&&Resize())},document.getElementById("stop-share-room-urls").onclick=function(){""==document.getElementById("stop-share-room-urls").style.display&&(document.getElementById("stop-share-room-urls").style.display="none",document.getElementById("share-room-urls").style.display="",document.getElementById("room-params").style.display="none",document.getElementById("room-urls").style.display="none"),connection.streamEvents.selectAll().length>0&&Resize(!1)},document.getElementById("status-close-btn").onclick=function(){statusHeaderHandler()},document.getElementById("config").onclick=function(){document.getElementById("room-settings").style.display="",document.getElementById("config").style.display="none",document.getElementById("stop-config").style.display="",connection.streamEvents.selectAll().length>0&&Resize(!1)},document.getElementById("stop-config").onclick=function(){document.getElementById("room-settings").style.display="none",document.getElementById("config").style.display="",document.getElementById("stop-config").style.display="none",connection.streamEvents.selectAll().length>0&&Resize(!1)};var additionalSettings=document.getElementById("additional-settings");function uiBeforeConnect(){reSetRoomLinks(),hideControls(),function(){if(-1==DetectRTC.browser.name.indexOf("Chrome"))return;navigator.connection&&"cellular"===navigator.connection.type&&navigator.connection.downlinkMax<=.115&&alert("2G is not supported. Please use a better internet service.");if(screen&&screen.orientation){var waitFullscreenTimeout;function waitFullscreenElement(){if(document.fullscreenElement&&"VIDEO"==document.fullscreenElement.nodeName)return DEBUG&&console.log("waitFullscreenElement is ok"),document.exitFullscreen&&document.exitFullscreen(),waitFullscreenTimeout&&window.clearTimeout(waitFullscreenTimeout),void setTimeout(ToggleFullScreen,500);waitFullscreenTimeout=setTimeout(waitFullscreenElement,1e3)}screen.orientation.addEventListener("change",function(e){DetectRTC.isMobileDevice&&"portrait-primary"!==screen.orientation.type&&waitFullscreenElement()})}if(void 0!==navigator.getBattery){var batteryCharged=!1;navigator.getBattery().then(function(battery){battery.addEventListener("chargingchange",function(){batteryCharged=battery.charging,DEBUG&&console.log(battery,batteryCharged)}),battery.addEventListener("levelchange",function(){var batteryLevel=Math.floor(100*battery.level)+"%";batteryCharged||.5!=battery.level&&.3!=battery.level&&.15!=battery.level||(DEBUG&&console.log("The battery is low. Plug in charging",batteryLevel),statusHeaderHandler(mess="The battery is low ("+batteryLevel+"). Plug in charging",5e3),DetectRTC.isMobileDevice&&window.navigator.vibrate([500,100,200])),batteryCharged||.1!=battery.level||DetectRTC.isMobileDevice&&window.navigator.vibrate([100,30,100,30,100,200,200,30,200,30,200,200,100,30,100,30,100])})})}}()}function disableUIElements(){document.getElementById("open-or-join-room").disabled=!0,document.getElementById("room-id").disabled=!0,document.getElementById("room-password").disabled=!0,document.getElementById("text-chat").disabled=!1,document.getElementById("setPassword").style.display="none",document.getElementById("participants-number").disabled=!0,document.getElementById("enable-admins").disabled=!0,document.getElementById("enableviewers").disabled=!0,document.getElementById("bottom").style.display="none",document.getElementById("manual-to-start").innerHTML="",statusHeaderHandler()}function hideControls(){DDTalkVersionNumber&&(document.getElementById("lib-version").innerHTML=DDTalkVersionNumber),isView||isAdmin||(document.getElementById("enable-admins").disabled=!1,document.getElementById("enableviewers").disabled=!1,document.getElementById("share-room-urls").onclick(),document.getElementById("config").onclick(),"OFF"===sessionStorage.getItem("quality")&&webcamSwitch.onclick()),isView&&(document.getElementById("share-room-urls").style.display="none",document.getElementById("text-chat").style.display="none",document.getElementById("draw").style.display="none",document.getElementById("room-settings").style.display="none",document.getElementById("webcam").style.display="none",document.getElementById("mic").style.display="none",document.getElementById("pre-recorded-media").style.display="none",document.getElementById("share-screen").style.display="none",document.getElementById("share-file").style.display="none",document.getElementById("config").style.display="none",document.getElementById("stop-config").style.display="none"),isAdmin&&(document.getElementById("mic").style.display="",document.getElementById("text-chat").style.display="none",document.getElementById("draw").style.display="none",document.getElementById("pre-recorded-media").style.display="none",document.getElementById("share-screen").style.display="none",document.getElementById("stats-info-off").style.display="none",document.getElementById("full-screen").style.display="none",document.getElementById("video-devices").style.display="none",document.getElementById("audio-devices").style.display="none",document.getElementById("open-or-join-room").disabled=!1,document.getElementById("participants-number").disabled=!1,document.getElementById("share-room-urls").onclick(),document.getElementById("config").onclick(),document.getElementById("additional-settings-checkbox").checked=!0,document.getElementById("additional-settings-checkbox").onchange())}function uiAfterConnect(){connection.extra.broadcaster&&connection.extra.roomInitiator?(document.title="DD Talk initiator role",document.getElementById("share-room-urls").onclick(),document.getElementById("config").onclick()):connection.extra.broadcaster&&!connection.extra.roomInitiator&&(document.getElementById("stop-share-room-urls").onclick(),document.getElementById("stop-config").onclick(),document.title=autoStart?"DD Talk autoconnect broadcaster":"DD Talk broadcaster role"),connection.extra.viewer&&(document.title="DD Talk View role"),connection.extra.admin&&(document.title="DD Talk Admin role")}function numberParticipantsinRoom(){var lbroadcasters=0,lviewers=0,ladmins=0;connection.extra.broadcaster?lbroadcasters+=1:connection.extra.viewer?lviewers+=1:connection.extra.admin&&(ladmins+=1),connection.getAllParticipants().length?connection.getAllParticipants().forEach(function(pid){if(!0===connection.peers[pid].extra.broadcaster)lbroadcasters+=1;else if(!0===connection.peers[pid].extra.viewer)lviewers+=1;else{if(!0!==connection.peers[pid].extra.admin)return;ladmins+=1}document.getElementById("participants-number-panel").style.display="",document.getElementById("helpLinks").style.display="none"}):(document.getElementById("participants-number-panel").style.display="none",document.getElementById("helpLinks").style.display=""),document.getElementById("join-num").innerHTML=lbroadcasters,document.getElementById("view-num").innerHTML=lviewers,document.getElementById("admin-num").innerHTML=ladmins,ladmins>0?(document.getElementById("admin-in-room").style.display="",document.getElementById("admin-not-in-room").style.display="none"):(document.getElementById("admin-in-room").style.display="none",document.getElementById("admin-not-in-room").style.display=""),document.getElementById("join-num").className="blink",document.getElementById("view-num").className="blink",document.getElementById("admin-num").className="blink",connection.isLowBandwidth&&(document.getElementById("join-num").style.color=document.getElementById("view-num").style.color=document.getElementById("admin-num").style.color="red"),setTimeout(numberParticipantsinRoom,2e3)}if(document.getElementById("additional-settings-checkbox").onchange=function(){"none"==additionalSettings.style.display?additionalSettings.style.display="":additionalSettings.style.display="none",connection.streamEvents.selectAll().length>0&&Resize()},!isView&&!isAdmin){var revisitSite=!1;if(revisitSite=localStorage.getItem("revisitSite")){var cameraPermission=!1,microphonePermission=!1;DetectRTC.load(function(){if(DetectRTC.isGetUserMediaSupported){function setUserMicrophonePermission(permission){DetectRTC.isWebsiteHasMicrophonePermissions=permission,sessionStorage.setItem("microphonePermission",permission),DEBUG&&console.log("Microphone Access: "+DetectRTC.isWebsiteHasMicrophonePermissions)}function setUserCameraPermission(permission){DetectRTC.isWebsiteHasWebcamPermissions=permission,sessionStorage.setItem("cameraPermission",permission),DEBUG&&console.log("Camera Access: "+DetectRTC.isWebsiteHasWebcamPermissions)}DetectRTC.hasMicrophone&&navigator.mediaDevices.getUserMedia({audio:!0,video:!1}).then(stream=>{stream.getAudioTracks().length>0&&(stream.getTracks().forEach(track=>track.stop()),DEBUG&&console.log("Check Audio stream",stream.getAudioTracks()),microphonePermission=!0),setUserMicrophonePermission(microphonePermission)}).catch(e=>{setUserMicrophonePermission(microphonePermission),DEBUG&&console.log("Error: microphone not available",e)}).then(()=>{DetectRTC.hasWebcam&&navigator.mediaDevices.getUserMedia({audio:!1,video:!0}).then(stream=>{stream.getVideoTracks().length>0&&(stream.getTracks().forEach(track=>track.stop()),DEBUG&&console.log("Check Video stream",stream.getVideoTracks()),cameraPermission=!0),setUserCameraPermission(cameraPermission)}).then(()=>{loadMediaDeviceAndConstraints()}).catch(e=>{setUserCameraPermission(cameraPermission),loadMediaDeviceAndConstraints(),DEBUG&&console.log("Error: camera is not available",e),statusHeaderHandler(mess="<h2>Web camera is not available. Try connect whithout video</h2>")})})}else alert("Warning: getUserMedia() is not supported in your browser "+DetectRTC.browser.name+" ("+DetectRTC.browser.fullVersion+")! Pls, use Google Chrome or Firefox last version if it's possible https://www.google.ru/intl/en_uk/chrome/"),DEBUG&&console.log("Service disconnected. Error: User Media not support "+DetectRTC.isGetUserMediaSupported)})}else{document.getElementById("full-screen").style.display="none",document.getElementById("share-room-urls").style.display="none",document.getElementById("webcam").style.display="none",document.getElementById("mic").style.display="none",document.getElementById("draw").style.display="none",document.getElementById("pre-recorded-media").style.display="none",document.getElementById("share-screen").style.display="none",document.getElementById("share-file").style.display="none",document.getElementById("stats-info-off").style.display="none",document.getElementById("open-or-join-room").disabled=!0,document.getElementById("room-id").disabled=!0,document.getElementById("room-password").disabled=!0,document.getElementById("text-chat").style.display="none",document.getElementById("stop-text-chat").style.display="none",document.getElementById("setPassword").style.display="none",document.getElementById("stat").style.display="none",document.getElementById("participants-number").disabled=!0,document.getElementById("enableviewers").disabled=!0,document.getElementById("enable-admins").disabled=!0,document.getElementById("transport-policy").disabled=!0,document.getElementById("audio-devices").disabled=!0,document.getElementById("video-devices").disabled=!0,document.getElementById("video-quality").disabled=!0,document.getElementById("rotate-video").disabled=!0,document.getElementById("bandwidth").disabled=!0,document.getElementById("audio-handling").disabled=!0,document.getElementById("room-urls").style.display="none",document.getElementById("room-settings").style.display="none",document.getElementById("config").style.display="none";var permissionToStartHTML=document.getElementById("manual-to-start");permissionToStartHTML.className="manual-to-start";var fileNameParkingPage=params.quality?"first-connect.html":"parking.html";fetch(fileNameParkingPage).then(response=>response.text()).then(html=>{permissionToStartHTML.innerHTML=html,document.getElementById("user-media-permission").addEventListener("click",()=>(function(){mess="<h2>Please provide access to your webcam and microphone</h2>",statusHeaderHandler(mess+="<p>"+DetectRTC.browser.name+" v."+DetectRTC.browser.fullVersion+"<br /><i>"+window.navigator.userAgent+"</i></p>"),permissionToStartHTML.innerHTML="";const videoElement=document.createElement("video");videoElement.muted="true",videoElement.controls="true",videoElement.style.height="50%",permissionToStartHTML.appendChild(videoElement),navigator.mediaDevices.getUserMedia({audio:!0,video:{facingMode:"environment"}}).then(stream=>{try{videoElement.srcObject=stream,videoElement.onloadedmetadata=(()=>{videoElement.play(),revisitSite=!0,localStorage.setItem("revisitSite",revisitSite),statusHeaderHandler(mess+="<h2>Access to the media is obtained!</h2>"),setTimeout(function(){videoElement.pause(),statusHeaderHandler(mess+="<h2>DD Talk is reloading ...</h2>"),stream.getTracks().forEach(track=>track.stop()),setTimeout(location.reload(),3e3)},3e3)})}catch(error){videoElement.src=window.URL.createObjectURL(stream),statusHeaderHandler(mess="<h2>Stream connect Issues</h2><p>"+error+"</p>")}}).catch(function(error){statusHeaderHandler(mess="<br /><h3>"+error+"</h3>"),DEBUG&&console.log("Error. Check permissions to Webcam or Microphone in your browser!",error)})})())}).catch(function(error){DEBUG&&console.log("Failed to load the template.",error)})}}if("true"==revisitSite&&!isView&&!isAdmin){mess=document.getElementById("start-massage-for-broadcaster").innerHTML;var warnMess="You browser: "+DetectRTC.browser.name+", OS name: "+DetectRTC.osName+", OS Version: "+DetectRTC.osVersion;"Mac OS X"===DetectRTC.osName||"iOS"===DetectRTC.osName?"Safari"!=DetectRTC.browser.name&&(mess+=document.getElementById("start-warning-massage-for-broadcaster-with-iOS").innerHTML,mess+=warnMess):"Chrome"!=DetectRTC.browser.name&&DetectRTC.browser.version<=69&&(mess+=document.getElementById("start-warning-massage-for-broadcaster").innerHTML,mess+=warnMess),document.getElementById("manual-to-start").innerHTML=mess}var libConstraints,libBandwidth,selectAudioDevices=document.getElementById("audio-devices"),selectVideoDevices=document.getElementById("video-devices"),selectStreamQuality=document.getElementById("video-quality"),selectRotateVideo=document.getElementById("rotate-video"),selectBandwidth=document.getElementById("bandwidth"),selectAspectRatio=document.querySelector("#aspectRatio"),selectFrameRate=document.querySelector("#frameRate"),selectCursor=document.querySelector("#cursor"),dontDublA={},dontDublV={};function loadMediaDeviceAndConstraints(){fetch("/dist/lib-media-constraints.json").then(response=>response.json()).then(json=>{var optionQ;libConstraints=json,Object.keys(libConstraints).forEach(function(key){(optionQ=document.createElement("option")).innerHTML=libConstraints[key].name,optionQ.value=key,selectStreamQuality.appendChild(optionQ)})}).then(()=>{fetch("/dist/lib-bandwidth-constraints.json").then(response=>response.json()).then(json=>{var optionB;libBandwidth=json;var libPromises=[];Object.keys(libBandwidth).forEach(function(key){(optionB=document.createElement("option")).innerHTML=libBandwidth[key].name,optionB.value=key,selectBandwidth.appendChild(optionB),libPromises.push(key)}),Promise.all(libPromises).then(()=>{!function(){if(isAdmin)return;navigator.mediaDevices.enumerateDevices().then(function(devices){devices.forEach(function(device){"audioinput"===device.kind?function(device){if(dontDublA[device.deviceId])return;dontDublA[device.deviceId]=!0;var option=document.createElement("option");option.innerHTML=device.label,option.value=device.deviceId?device.deviceId:device.label,selectAudioDevices.appendChild(option)}(device):"videoinput"===device.kind&&function(deviceV){if(dontDublV[deviceV.deviceId])return;dontDublV[deviceV.deviceId]=!0;var optionV=document.createElement("option");optionV.innerHTML=deviceV.label,optionV.value=deviceV.deviceId?deviceV.deviceId:deviceV.label,selectVideoDevices.appendChild(optionV)}(device)})}).then(function(){return sessionStorageRotateVideoItem(),sessionStorageQualityItem(),sessionStorageBandwidthItem(),(cameraPermission||"OFF"!=selectStreamQuality.value)&&function(){var getStorageItem=sessionStorage.getItem("video");if(null!==getStorageItem){for(var i=0;i<selectVideoDevices.options.length;i++)if(selectVideoDevices.options[i].text==getStorageItem){selectVideoDevices.value=selectVideoDevices.options[i].value;var loadDataisCorrect=!0}loadDataisCorrect||(selectVideoDevices.value=selectVideoDevices.options[0].value,sessionStorage.setItem("video",selectVideoDevices.options[0].text))}else selectVideoDevices.value=selectVideoDevices.options[0].value,sessionStorage.setItem("video",selectVideoDevices.options[0].text)}(),microphonePermission&&function(){var getStorageItem=sessionStorage.getItem("audio");if(null!==getStorageItem){for(var i=0;i<selectAudioDevices.options.length;i++)if(selectAudioDevices.options[i].text==getStorageItem){selectAudioDevices.value=selectAudioDevices.options[i].value;var loadDataisCorrect=!0}loadDataisCorrect||(selectAudioDevices.value=selectAudioDevices.options[0].value,sessionStorage.setItem("audio",selectAudioDevices.options[0].text))}else selectAudioDevices.value=selectAudioDevices.options[0].value,sessionStorage.setItem("audio",selectAudioDevices.options[0].text)}(),null}).catch(function(err){DEBUG&&console.log(err.name+": "+err.message)})}(),startICETransportHandler()}).then(()=>{htmlSelectorHandlers(),AdditionalVideoSettings(),shiftSlider.addEventListener("change",function(){sessionStorage.setItem("shiftSliderTextValue",this.value),shiftSliderTextValue.value=this.value,jungle&&jungle.setPitchOffset(this.value)}),shiftSlider.addEventListener("input",function(){sessionStorage.setItem("shiftSliderTextValue",this.value),shiftSliderTextValue.value=this.value,jungle&&jungle.setPitchOffset(this.value)}),shiftSliderTextValue.onkeyup=function(e){13==e.keyCode&&(this.value=this.value.replace(/^\s+|\s+$/g,""),this.value=encodeURIComponent(this.value),this.value.length&&(sessionStorage.setItem("shiftSliderTextValue",this.value),shiftSlider.value=this.value,jungle&&jungle.setPitchOffset(this.value)))}}).then(()=>{uiBeforeConnect(),setTimeout(function(){autoStart?!autoStart||isView||isAdmin||(DEBUG&&console.log("Broadcasters auto-join-room"),recheckSetupParams(),disableUIElements(),startJoinRoom()):(buttonOpenjoin.disabled=!1,buttonOpenjoin.focus(),buttonOpenjoin.onclick=function(){recheckSetupParams(),disableUIElements(),connection.checkPresence(roomid,function(isRoomExist){1==isRoomExist?startJoinRoom():startOpenRoom()})})},1e3)})}).catch(err=>DEBUG&&console.error("Error bandwidth-constraints: ",err))}).catch(err=>DEBUG&&console.error("Error lib-media-constraints: ",err))}function sessionStorageQualityItem(){cameraPermission?cameraPermission&&(Object.keys(libConstraints).indexOf(params.quality)>-1&&(selectStreamQuality.value=params.quality),!params.quality&&Object.keys(libConstraints).indexOf(sessionStorage.getItem("quality"))>-1?selectStreamQuality.value=sessionStorage.getItem("quality"):params.quality||sessionStorage.getItem("quality")||(selectStreamQuality.value=Object.keys(libConstraints)[0]),sessionStorage.setItem("quality",selectStreamQuality.value),selectVideoDevices.style.display="",selectRotateVideo.style.display=""):(selectStreamQuality.value="OFF",sessionStorage.setItem("quality",selectStreamQuality.value),selectVideoDevices.style.display="none",selectRotateVideo.style.display="none",selectStreamQuality.disabled=!0)}function sessionStorageBandwidthItem(){Object.keys(libBandwidth).indexOf(params.bandwidth)>-1&&(selectBandwidth.value=params.bandwidth),!params.bandwidth&&Object.keys(libBandwidth).indexOf(sessionStorage.getItem("bandwidth"))>-1?selectBandwidth.value=sessionStorage.getItem("bandwidth"):params.bandwidth||sessionStorage.getItem("bandwidth")||(selectBandwidth.value=Object.keys(libBandwidth)[0]),sessionStorage.setItem("bandwidth",selectBandwidth.value)}function sessionStorageRotateVideoItem(){var rotateVideoFromSessionStorage=sessionStorage.getItem("rotate-video");selectRotateVideo.value=rotateVideoFromSessionStorage||selectRotateVideo[0].value,sessionStorage.setItem("rotate-video",selectRotateVideo.value)}function setConstraints(){return connection.mediaConstraints.audio=libConstraints[selectStreamQuality.value].audio,connection.mediaConstraints.audio.deviceId=selectAudioDevices.value?{exact:selectAudioDevices.value}:void 0,cameraPermission&&"OFF"!=selectStreamQuality.value?(connection.mediaConstraints.video=libConstraints[selectStreamQuality.value].video,connection.mediaConstraints.video.deviceId=selectVideoDevices.value?{exact:selectVideoDevices.value}:void 0,"fit-screen"===selectStreamQuality.value&&(connection.mediaConstraints.video.width=Resize().width,connection.mediaConstraints.video.height=Resize().height),webcamSwitch.style.display="",webcamSwitchOff.style.display="none"):(connection.mediaConstraints.video=!1,webcamSwitch.style.display="none",webcamSwitchOff.style.display=""),sessionStorage.setItem("quality",selectStreamQuality.value),DEBUG&&console.log("connection.mediaConstraints",connection.mediaConstraints),connection.mediaConstraints}function setBandwidth(){return connection.bandwidth={audio:!!parseInt(libBandwidth[selectBandwidth.value].audio)&&parseInt(libBandwidth[selectBandwidth.value].audio),video:!!parseInt(libBandwidth[selectBandwidth.value].video)&&parseInt(libBandwidth[selectBandwidth.value].video)},DEBUG&&console.log("connection.bandwidth",connection.bandwidth),connection.bandwidth}function htmlSelectorHandlers(){selectAudioDevices.onchange=function(){sessionStorage.setItem("audio",this.options[this.selectedIndex].text),SwitchMedia()},selectVideoDevices.onchange=function(){sessionStorage.setItem("video",this.options[this.selectedIndex].text),SwitchMedia()},selectStreamQuality.onchange=function(){sessionStorage.setItem("quality",selectStreamQuality.value),function(){if(setConstraints(),reSetRoomLinks(),isAdmin)return;if(0==connection.attachStreams.length)return;if(!cameraPermission||"OFF"==selectStreamQuality.value||!RMCMediaTrack.cameraStream.getVideoTracks()[0])return void SwitchMedia();var constraints=connection.mediaConstraints;null==RMCMediaTrack.screen&&null==RMCMediaTrack.preRecorededStream&&null==RMCMediaTrack.audioHandler||(delete constraints.video.deviceId,delete constraints.audio.autoGainControl,delete constraints.audio.echoCancellation,delete constraints.audio.noiseSuppression,delete constraints.audio.deviceId);RMCMediaTrack.cameraStream.getVideoTracks()[0].applyConstraints(constraints.video).then(function(){DEBUG&&console.log(JSON.stringify(RMCMediaTrack.cameraStream.getVideoTracks()[0].getSettings(),null,2))}).then(function(){RMCMediaTrack.cameraStream.getAudioTracks()[0].applyConstraints(constraints.audio),DEBUG&&console.log(JSON.stringify(RMCMediaTrack.cameraStream.getAudioTracks()[0].getSettings(),null,2))}).catch(function(e){DEBUG&&console.log(e)})}()},selectBandwidth.onchange=function(){sessionStorage.setItem("bandwidth",selectBandwidth.value),function(){if(setBandwidth(),reSetRoomLinks(),isAdmin)return;if(!connection.getAllParticipants().length)return;if("Chrome"===DetectRTC.browser.name&&"RTCRtpSender"in window&&"setParameters"in window.RTCRtpSender.prototype){connection.attachStreams.length&&connection.getAllParticipants().forEach(function(pid){1!=connection.getExtraData(pid).admin&&0!=connection.getExtraData(pid).broadcaster&&(selectBandwidth.disabled=!0,function(pid){connection.peers[pid].peer.getSenders().forEach(function(rtpSender){function updateBandwidth(typeStream,rtpSender){if(rtpSender.track.kind===typeStream){const parameters=rtpSender.getParameters(),bandwidth="video"==typeStream?connection.bandwidth.video:connection.bandwidth.audio;0==bandwidth?delete parameters.encodings[0].maxBitrate:parameters.encodings[0].maxBitrate=8*bandwidth*1024,rtpSender.setParameters(parameters).then(()=>{DEBUG&&console.log("Renegotiate Bandwidth parameters "+typeStream+":",parameters),selectBandwidth.disabled=!1}).catch(e=>{DEBUG&&console.error("Renegotiate Bandwidth error",e)})}}rtpSender&&rtpSender.track&&(updateBandwidth("video",rtpSender),updateBandwidth("audio",rtpSender))})}(pid))})}else location.reload()}()}}function SwitchMedia(){if(!isAdmin&&(recheckSetupParams(),cameraPermission&&"OFF"!=selectStreamQuality.value?cameraPermission&&"OFF"!=selectStreamQuality.value&&(selectVideoDevices.style.display="",selectRotateVideo.style.display="",connection.session={audio:!0,video:!0,data:!0}):(selectVideoDevices.style.display="none",selectRotateVideo.style.display="none",connection.session={audio:!0,video:!1,data:!0}),RMCMediaTrack.screen&&(selectRotateVideo.value="default",selectRotateVideo.onchange()),RMCMediaTrack.preRecorededStream&&preRecordedMediaClose.onclick(),connection.attachStreams.length)){if(!RMCMediaTrack.cameraVideoTrack&&RMCMediaTrack.cameraAudioTrack)return RMCMediaTrack.cameraAudioTrack.stop(),connection.getAllParticipants().forEach(function(p){connection.disconnectWith(p)}),void setTimeout(function(){location.reload()},500);connection.getAllParticipants().forEach(function(p){connection.attachStreams.forEach(function(stream){connection.peers[p].peer.removeStream(stream)})}),connection.attachStreams.forEach(function(stream){stream.stop()}),connection.attachStreams=[],connection.renegotiate(),setTimeout(function(){"OFF"==selectStreamQuality.value&&null!=RMCMediaTrack.cameraVideoTrack?(stopAudioHandling(),RMCMediaTrack.cameraVideoTrack=null,connection.addStream({audio:!0})):connection.addStream({audio:!0,video:!0}),connection.extra.adminEnableStatus&&connection.socket.emit(connection.socketCustomEvent,{userDeleteFromBackup:connection.userid})},2e3)}}function AdditionalVideoSettings(){sessionStorage.getItem("display-aspectRatio")?selectAspectRatio.value=sessionStorage.getItem("display-aspectRatio"):selectAspectRatio.value=selectAspectRatio[0].value,selectAspectRatio.onchange=function(){sessionStorage.setItem("display-aspectRatio",this.value),RMCMediaTrack.cameraStream&&RMCMediaTrack.cameraStream.getVideoTracks()[0]&&RMCMediaTrack.cameraStream.getVideoTracks()[0].applyConstraints(selectConstraintsForDisplayMediaStream())},sessionStorage.getItem("display-frameRate")?selectFrameRate.value=sessionStorage.getItem("display-frameRate"):selectFrameRate.value=selectFrameRate[0].value,selectFrameRate.onchange=function(){sessionStorage.setItem("display-frameRate",this.value),RMCMediaTrack.cameraStream&&RMCMediaTrack.cameraStream.getVideoTracks()[0]&&RMCMediaTrack.cameraStream.getVideoTracks()[0].applyConstraints(selectConstraintsForDisplayMediaStream())},sessionStorage.getItem("display-cursor")?selectCursor.value=sessionStorage.getItem("display-cursor"):selectCursor.value=selectCursor[0].value,selectCursor.onchange=function(){sessionStorage.setItem("display-cursor",this.value),RMCMediaTrack.cameraStream&&RMCMediaTrack.cameraStream.getVideoTracks()[0]&&RMCMediaTrack.cameraStream.getVideoTracks()[0].applyConstraints(selectConstraintsForDisplayMediaStream())}}function selectConstraintsForDisplayMediaStream(){var videoConstraints={};return"default"!==selectAspectRatio.value&&(videoConstraints.aspectRatio=selectAspectRatio.value),"default"!==selectFrameRate.value&&(videoConstraints.frameRate=selectFrameRate.value),"default"!==selectCursor.value&&(videoConstraints.cursor=selectCursor.value),videoConstraints}var libIceServers,isICETransport,transportPolicyHTML=document.getElementById("transport-policy");function startICETransportHandler(){fetch("/dist/lib-ice-servers.json").then(response=>response.json()).then(json=>{var optionS;libIceServers=json,Object.keys(libIceServers).forEach(function(key){(optionS=document.createElement("option")).innerHTML=key,optionS.value=libIceServers[key].name,transportPolicyHTML.appendChild(optionS),key===getKeyByValue(libIceServers,"stun")&&0===libIceServers[key].urls.length?(0===siteConfigSTUNAdress.length&&(siteConfigSTUNAdress="stun:stun.l.google.com:19302"),libIceServers[key].urls=siteConfigSTUNAdress):key===getKeyByValue(libIceServers,"turn")&&0===libIceServers[key].urls.length&&(libIceServers[key].urls=siteConfigTURNAdress,0===libIceServers[key].username.length&&(libIceServers[key].username=siteConfigTURNUser),0===libIceServers[key].credential.length&&(libIceServers[key].credential=siteConfigTURNCredential))})}).then(()=>{isICETransport=params.ice?"default"===params.ice?"default":"turn"===params.ice?"turn":"stun"===params.ice?"stun":"google"===params.ice?"google":"default":sessionStorage.getItem("transport-policy")?sessionStorage.getItem("transport-policy"):"default",setTransportPolicy(),function(){if(!connection.iceServers[1])return;!function(turnServer,callback){let pc,candidates;function gotDescription(desc){candidates=[],pc.setLocalDescription(desc)}function noDescription(error){console.error("TURN Server error:",error)}(pc=new RTCPeerConnection({iceServers:[turnServer],iceTransportPolicy:"relay",iceCandidatePoolSize:0})).onicecandidate=iceCallback,pc.onicegatheringstatechange=gatheringStateChange,pc.createOffer({offerToReceiveAudio:1}).then(gotDescription,noDescription);var number_of_relay_pairs=0;function iceCallback(event){if(event.candidate){const c=function(text){const pos=text.indexOf("candidate:")+"candidate:".length;let[foundation,component,protocol,priority,address,port,,type]=text.substr(pos).split(" ");return{component:component,type:type,foundation:foundation,protocol:protocol,address:address,port:port,priority:priority}}(event.candidate.candidate);"relay"===c.type&&number_of_relay_pairs++}else callback&&callback(number_of_relay_pairs>0),callback=null,"onicegatheringstatechange"in RTCPeerConnection.prototype||(pc.close(),pc=null)}function gatheringStateChange(){"complete"===pc.iceGatheringState&&(pc.close(),pc=null)}}(libIceServers[getKeyByValue(libIceServers,"turn")],function(isActive){document.getElementById("coturn-status").title=isActive?"CoTURN is Active":"CoTURN is off line",document.getElementById("coturn-status").innerHTML=isActive?"&#10033;":"&#10048;",document.getElementById("coturn-status").style.color=isActive?"#f17f5d":"#ff0000",DEBUG&&console.log("TURN Server is Active",isActive)})}()}).catch(err=>DEBUG&&console.error("Error lib-ice-servers.json: ",err))}function setTransportPolicy(){"default"===isICETransport?(connection.candidates={host:!0,stun:!0,turn:!0},connection.iceTransportPolicy="all",connection.iceServers=[],Object.keys(libIceServers).forEach(function(key){key!==getKeyByValue(libIceServers,"stun")&&key!==getKeyByValue(libIceServers,"turn")||connection.iceServers.push(libIceServers[key])})):"turn"===isICETransport?(connection.candidates={turn:!0,stun:!1,host:!1},connection.iceTransportPolicy="relay",connection.iceServers=[],connection.iceServers.push(libIceServers[getKeyByValue(libIceServers,isICETransport)])):"stun"===isICETransport?(connection.candidates={host:!0,stun:!0,turn:!1},connection.iceTransportPolicy=null,connection.iceServers=[],connection.iceServers.push(libIceServers[getKeyByValue(libIceServers,isICETransport)])):"google"===isICETransport&&(connection.candidates={host:!0,stun:!0,turn:!1},connection.iceTransportPolicy=null,connection.iceServers=[],connection.iceServers.push(libIceServers[getKeyByValue(libIceServers,isICETransport)])),transportPolicyHTML.value=isICETransport,sessionStorage.setItem("transport-policy",isICETransport),DEBUG&&console.log("isICETransport:",isICETransport,"connection.candidates:",connection.candidates),reSetRoomLinks(),!isAdmin&&connection.getAllParticipants().length&&(connection.close(),connection.closeSocket(),setTimeout(function(){afterReConnection()},Math.floor(1e3*Math.random())+1e3))}function getKeyByValue(object,value){return Object.keys(object).find(key=>object[key].name===value)}function recheckSetupParams(){connection.socketCustomEvent="DDTalkService"+roomid,connection.socketMessageEvent=roomid,isView||(connection.mediaConstraints=setConstraints(),connection.bandwidth=setBandwidth()),connection.maxParticipantsAllowed=setParticipants,isPassword&&(connection.password=isPassword)}transportPolicyHTML.onchange=function(){isICETransport=this.value,setTransportPolicy()};var joinTimeoutFunction,buttonOpenjoin=document.getElementById("open-or-join-room");buttonOpenjoin.disabled=!0;var reconnectCounter=-1;function startJoinRoom(){connection.isInitiator=!1,connection.extra=isView?{joinedAt:time(),roomInitiator:!1,broadcaster:!1,viewer:!0,viewerEnableStatus:enableViewers,admin:!1,adminEnableStatus:!1}:isAdmin?{joinedAt:time(),roomInitiator:!1,broadcaster:!1,viewer:!1,viewerEnableStatus:enableViewers,admin:!0,adminEnableStatus:!1}:{joinedAt:time(),roomInitiator:!1,broadcaster:!0,viewer:!1,viewerEnableStatus:enableViewers,admin:!1,adminEnableStatus:!1},roomViewer=[],statusHeaderHandler(mess="Joining..."),connection.connectionDescription=connection.join(roomid,function(isRoomJoined,roomid,error){if(error){if(error===connection.errors.ROOM_FULL)return statusHeaderHandler(mess="Room is full.\n\nPlease wait for someone to leave the room"),DEBUG&&console.info(mess),void setTimeout(startJoinRoom,5e3);if(error===connection.errors.INVALID_PASSWORD)return mess="Invalid password",DEBUG&&console.info(mess),isPassword=connection.password=sanitizePassParams(prompt("Please enter room password")),statusHeaderHandler(mess="Сhecking the password..."),void setTimeout(startJoinRoom,5e3)}1==isRoomJoined?(reconnectCounter++,uiAfterConnect(),afterConnectingSocket(),checkInternetConnect(),reCheckWhoisRoomOwner(),numberParticipantsinRoom(),enableViewersHandler(),enableAdminsHandler(),isAdmin||removeBrokenMediaContainers(),connection.extra.broadcaster&&(autoStart=!0,changeLinksInRoomUrlsPanel("broadcaster",!1,!0),broadcasterSendsPeerstoViewers()),statusHeaderHandler(mess="Join to room "+roomid,2e3),DEBUG&&console.info("Join to room"+roomid+" Start session time",time(),"Number off reconnect",reconnectCounter)):(mess="This room does not exist. Wait for the initiator to open it.",connection.extra.broadcaster&&(mess+=' Or <a href="/">open the room</a> yourself'),statusHeaderHandler(mess),joinTimeoutFunction=setTimeout(startJoinRoom,Math.floor(1e3*Math.random())+3e3))})}function startOpenRoom(){connection.extra=isAdmin?{joinedAt:time(),roomInitiator:!0,broadcaster:!1,viewer:!1,viewerEnableStatus:enableViewers,admin:!0,adminEnableStatus:enableAdmins}:{joinedAt:time(),roomInitiator:!0,broadcaster:!0,viewer:!1,viewerEnableStatus:enableViewers,admin:!1,adminEnableStatus:enableAdmins},connection.open(roomid,function(isRoomOpen){!1===isRoomOpen?(statusHeaderHandler(mess="This room already exsists.  Trying to join the room"),DEBUG&&console.info(mess),setTimeout(startJoinRoom,1e3)):(reconnectCounter++,uiAfterConnect(),afterConnectingSocket(),checkInternetConnect(),enableViewersHandler(),enableAdminsHandler(),reCheckWhoisRoomOwner(),numberParticipantsinRoom(),isAdmin||removeBrokenMediaContainers(),statusHeaderHandler(mess="The room is open. Copy and share the link for communication",5e3),DEBUG&&console.log("Ok. The room is open: "+roomid+" Start session time",time()))})}var reconnectStatus=!1;function afterReConnection(){if(0!=connection.getAllParticipants().length||1!=socketHandler&&0!=connection.isOnline||0!=reconnectStatus){if(0==connection.getAllParticipants().length&&1==connection.isOnline&&0==socketHandler&&1==reconnectStatus)return reconnectStatus=!1,void setTimeout(function(){startJoinRoom()},3e3)}else statusHeaderHandler(mess="Start Reconnect function"),DEBUG&&console.warn("Start afterReConnection"),reconnectStatus=!0,connection.dontCaptureUserMedia=!0,connection.getAllParticipants().forEach(function(pid){connection.disconnectWith(pid)}),isAdmin&&clearAdminUsersPanel(),isView||recheckSetupParams(),connection.close(),connection.closeSocket(),socketHandler=!1,function(){var localMediaContainer=document.getElementById(connection.userid),UIuserIDOwnerIndicator=document.getElementById(connection.userid+"-initiator");if(!localMediaContainer||!UIuserIDOwnerIndicator)return;setTimeout(function(){connection.userid=connection.token(),isAdmin||isView?isAdmin&&(localMediaContainer.setAttribute("id",connection.userid),localMediaContainer.innerHTML=connection.userid,UIuserIDOwnerIndicator&&(UIuserIDOwnerIndicator.setAttribute("id",connection.userid+"-initiator"),UIuserIDOwnerIndicator.innerHTML="")):(localMediaContainer.setAttribute("id",connection.userid),localMediaContainer.querySelector("h2").innerHTML=connection.userid,localMediaContainer.querySelector("video").setAttribute("data-userid",connection.userid))},200)}(),window.RemoteMediaTrack=[],roomViewer=[];setTimeout(afterReConnection,3e3)}function checkInternetConnect(){0==connection.isOnline&&(statusHeaderHandler(mess="No Internet access. Check Internet connect"),DEBUG&&console.warn("Offline status"),connection.getAllParticipants().forEach(function(pid){connection.disconnectWith(pid)})),setTimeout(checkInternetConnect,2e3)}var isOwnerStatus=connection.isInitiator;function reCheckWhoisRoomOwner(){0!=connection.getAllParticipants.length&&isOwnerStatus!=connection.isInitiator&&(DEBUG&&console.warn("Status changed to "+(connection.isInitiator?"isInitiator":"isJoiner")),1==(isOwnerStatus=connection.extra.roomInitiator=connection.isInitiator)&&(enableAdminsHandler(),enableViewersHandler(),connection.updateExtraData()),1==connection.isInitiator?(enableViewersHTML.disabled=!1,enableAdminsHTML.disabled=!1,document.getElementById("menu").style.background="#e2d4d1"):(enableViewersHTML.disabled=!0,enableAdminsHTML.disabled=!0,document.getElementById("menu").style.background="#ffffff")),setTimeout(reCheckWhoisRoomOwner,5e3)}var adminMessageContainerHTML,usresHTML,usersPanelHTML,usersClosedHTML,roomViewer=[];function broadcasterSendsPeerstoViewers(){isView||isAdmin||!enableViewers||(connection.getAllParticipants().forEach(function(pid){if(pid!=connection.userid&&!0===connection.peers[pid].extra.viewer){if(roomViewer[pid]==pid)return;roomViewer[pid]=pid,connection.renegotiate(),DEBUG&&console.warn("Broadcaster send stream to viewer: ",roomViewer[pid])}}),setTimeout(broadcasterSendsPeerstoViewers,2e3))}isView&&(connection.session={oneway:!0},connection.direction="one-way",connection.dontCaptureUserMedia=!0,startICETransportHandler(),recheckSetupParams(),uiBeforeConnect(),disableUIElements(),DEBUG&&console.log("Viewer auto-join-room."),startJoinRoom()),isAdmin&&(cameraPermission=!0,revisitSite=!0,enableViewers=!0,fetch("/dist/lib-media-constraints.json").then(response=>response.json()).then(json=>{var optionQ;libConstraints=json,Object.keys(libConstraints).forEach(function(key){(optionQ=document.createElement("option")).innerHTML=libConstraints[key].name,optionQ.value=key,selectStreamQuality.appendChild(optionQ)})}).then(()=>{fetch("/dist/lib-bandwidth-constraints.json").then(response=>response.json()).then(json=>{var optionB;libBandwidth=json;var libPromises=[];Object.keys(libBandwidth).forEach(function(key){(optionB=document.createElement("option")).innerHTML=libBandwidth[key].name,optionB.value=key,selectBandwidth.appendChild(optionB),libPromises.push(key)}),Promise.all(libPromises).then(()=>{sessionStorageRotateVideoItem(),sessionStorageQualityItem(),sessionStorageBandwidthItem(),startICETransportHandler()}).then(()=>{htmlSelectorHandlers(),AdditionalVideoSettings(),connection.socketCustomEvent="DDTalkService"+roomid,connection.socketMessageEvent=roomid,connection.sessionid=roomid,connection.session={data:!0},connection.mediaConstraints={audio:!1,video:!1},connection.sdpConstraints.mandatory={OfferToReceiveAudio:!1,OfferToReceiveVideo:!1},connection.direction="one-way",connection.dontAttachStream=!0,connection.dontCaptureUserMedia=!0,connection.dontGetRemoteStream=!0,connection.setUserPreferences=function(userPreferences){return connection.dontAttachStream&&(userPreferences.dontAttachLocalStream=!0),connection.dontGetRemoteStream&&(userPreferences.dontGetRemoteStream=!0),userPreferences},connection.autoCreateMediaElement=!1,connection.onstream=connection.onmute=connection.onunmute=function(event){},hideControls(),buttonOpenjoin.focus(),buttonOpenjoin.onclick=function(){joinTimeoutFunction&&clearTimeout(joinTimeoutFunction),connection.getAllParticipants().forEach(function(pid){connection.disconnectWith(pid)}),clearAdminUsersPanel(),document.getElementById(connection.userid),document.getElementById(connection.userid+"-initiator"),setTimeout(function(){disableAfterSocketDisconnectReconnect=!0,connection.closeSocket(),recheckSetupParams(),connection.checkPresence(roomid,function(isRoomExist){disableAfterSocketDisconnectReconnect=!1,1==isRoomExist?startJoinRoom():startOpenRoom()})},500)}}).then(()=>{reSetRoomLinks(),recheckSetupParams(),startJoinRoom()}).then(()=>{!function(){if(!isAdmin)return;adminUIContainer.style.display="";var newSS=document.createElement("link");newSS.rel="stylesheet",newSS.type="text/css",newSS.href="./admin.css",document.getElementsByTagName("head")[0].appendChild(newSS),(adminMessageContainerHTML=document.createElement("div")).id="admin-message-container",adminMessageContainerHTML.innerHTML='<h2>Admin ID <span id="'+connection.userid+'">'+connection.userid+'</span> <span id="'+connection.userid+'-initiator"></span></h2><br />',adminUIContainer.appendChild(adminMessageContainerHTML);var messageText=document.createElement("textarea");messageText.id="message-input",messageText.style="width: 80%; padding:20px",messageText.placeholder="...",messageText.value="",adminMessageContainerHTML.appendChild(messageText),adminMessageContainerHTML.appendChild(document.createElement("br")),document.getElementById("message-input").onclick=messageTextHandler;var messageSendButton=document.createElement("button");messageSendButton.id="send-message-button",messageSendButton.style="margin-bottom: 20px;",messageSendButton.innerHTML="Send to all broadcasters",adminMessageContainerHTML.appendChild(messageSendButton),document.getElementById("send-message-button").onclick=function(){adminMessageHandler()},(usresHTML=document.createElement("div")).id="participantList",usresHTML.style="text-align: left; padding-left: 5%;",usresHTML.innerHTML="<h2>Partisipanst list</h2>",usresHTML.innerHTML+='<div>&#10093; Send commands to all autoconnect participants: <span id="all-change-room" style="color:orange;cursor:pointer;" title="Change random RoomID for all broadcasters and admins">CHANGE ROOM</span> || <span id="all-reload" style="color:orange;cursor:pointer;" title="for all users">RELOAD</span> || <span id="all-reconnect" style="color:orange;cursor:pointer;" title="for all users">RECONNECT</span> || <span id="all-close-connect" style="color:orange;cursor:pointer;" title="for all users">CLOSE CONNECT</span> || <span id="all-quality-setup" style="color:orange;cursor:pointer;" title="for all users">SEND SETTINGS</span> || <span title="disable microphones for current and new broadcasters">DISABLE ALL MICROPHONES <label class="switch"><input type="checkbox" id="all-switch"><div class="slider"></span></div></label></div><br />',adminUIContainer.appendChild(usresHTML),document.getElementById("all-change-room").onclick=function(){!function(){var newRoom=randomString()+randomString();if(0==window.confirm('Please select "OK" to confirm Change Room '+newRoom+" for all user"))return;connection.socket.emit(connection.socketCustomEvent,{newRoom:newRoom}),roomid=document.getElementById("room-id").value=newRoom.replace(/[^а-яА-ЯёЁA-Za-z0-9]+/g,""),reSetRoomLinks(),setTimeout(function(){buttonOpenjoin.onclick()},Math.floor(1e3*Math.random())+1e3)}()},document.getElementById("all-reload").onclick=function(){sendReload()},document.getElementById("all-reconnect").onclick=function(){sendReconnect()},document.getElementById("all-close-connect").onclick=function(){sendCloseConnect()},document.getElementById("all-quality-setup").onclick=function(){sendParams()},document.getElementById("all-switch").onclick=function(){audioOnOffSwitch()};var getStorageBroadcasterAudioStatus=parseFloat(sessionStorage.getItem("mic-for-broadcaster-all"));isNaN(getStorageBroadcasterAudioStatus)||"1"!=getStorageBroadcasterAudioStatus||(document.getElementById("all-switch").checked=!0,setTimeout(function(){Object.keys(userBackup).forEach(function(pid){"Broadcaster"===userBackup[pid]&&sessionStorage.setItem("mic-for-broadcaster-"+pid,1)}),audioOnOffSwitch()},3e3));usersPanelHTML=document.createElement("div"),usresHTML.appendChild(usersPanelHTML),usersClosedHTML=document.createElement("div"),usresHTML.appendChild(usersClosedHTML),checkwhoisRoomOwner(),allParticipantsHandler()}()})}).catch(err=>console.error("Error: ",err))}).catch(err=>console.error("Error: ",err)));var userBackup=[],userControlsHTML=[],adminEnableStatus=!1,adminUIContainer=document.getElementById("manual-to-start");function checkwhoisRoomOwner(){isAdmin&&(1==connection.isInitiator?(document.getElementById(connection.userid+"-initiator").innerHTML="(Room Owner)",adminEnableStatus=connection.extra.adminEnableStatus):connection.getAllParticipants().forEach(function(pid){var initiatorUI=document.getElementById(pid+"-initiator");!0===connection.peers[pid].extra.roomInitiator?(initiatorUI&&(initiatorUI.innerHTML="(Room Owner)"),adminEnableStatus=connection.getExtraData(pid).adminEnableStatus):(initiatorUI&&(initiatorUI.innerHTML=""),document.getElementById(connection.userid+"-initiator")&&(document.getElementById(connection.userid+"-initiator").innerHTML=""))}),setTimeout(checkwhoisRoomOwner,2e3))}function allParticipantsHandler(){if(isAdmin){var usersArray=[],getAllPIDPromises=[];connection.getAllParticipants().forEach(function(pid){if(pid!==connection.userid)if(adminEnableStatus){if(connection.getExtraData(pid).joinedAt!=connection.extra.joinedAt){if(!0===connection.getExtraData(pid).broadcaster)usersArray[pid]="Broadcaster";else if(!0===connection.getExtraData(pid).viewer)usersArray[pid]="Viewer";else{if(!0!==connection.getExtraData(pid).admin)return void setTimeout(allParticipantsHandler,1e3);usersArray[pid]="Admin"}getAllPIDPromises.push(pid)}}else clearAdminUsersPanel()}),Promise.all(getAllPIDPromises).then(()=>{Object.keys(usersArray).forEach(function(pid){Object.keys(userBackup).indexOf(pid)<=-1&&(userBackup[pid]=usersArray[pid],function(pid,role){if(!isAdmin)return;document.getElementById(pid)&&userDeleteHandler(pid);var reload,reconnect,closeConnect,roleColor,quality,message,audioStatusSwitch,volumeSliderAudio,volumeLabelAudio;DEBUG&&console.warn("!!!PID",pid,"role",role),roleColor="Broadcaster"==role?"#ff9b00":"Viewer"==role?"#fff900":"Admin"==role?"#9e9e9e":"#ff0000";var userControls="&#10093; <b>"+pid+' <span style="color:red;" id="'+pid+'-initiator"></span></b> is <span id="'+pid+'-role" style="background:'+roleColor+'; padding:4px;">'+role+'</span> <span style="color:back;cursor:pointer;" id="'+pid+'-reload">Reload</span> || <span style="color:back;cursor:pointer;" id="'+pid+'-reconnect">Reconnect</span> || <span style="color:back;cursor:pointer;" id="'+pid+'-close-connect">Close connect</span> || <span style="color:black;cursor:pointer;" id="'+pid+'-quality">Send Settings</span> ||<span style="color:black;cursor:pointer;" id="'+pid+'-message">Private message</span> <span id="'+pid+'-volume-audio-label" style= "vertical-align:middle;display:none;"> || Mic level for viewers: </span><span id="'+pid+'-volume-audio-label-value">1.00</span><input id="'+pid+'-volume-audio" type="range" min="0" max="1" step="0.01" value="1" style= "vertical-align:middle; cursor: pointer; display:none;" /><span id="'+pid+'-mic-controle" style= "vertical-align:middle;display:none;"> || Microphone OFF <label class="switch"><input type="checkbox" id="'+pid+'-switch"><div class="slider"></div></label></span><br />';if(userControlsHTML[pid]=document.createElement("p"),userControlsHTML[pid].id=pid,userControlsHTML[pid].style="",userControlsHTML[pid].innerHTML=userControls,usersPanelHTML.appendChild(userControlsHTML[pid]),volumeSliderAudio=document.getElementById(pid+"-volume-audio"),volumeLabelAudio=document.getElementById(pid+"-volume-audio-label-value"),"Broadcaster"==role){var getStorageBroadcasterVolume=parseFloat(sessionStorage.getItem("volume-for-broadcaster-"+pid)).toFixed(2);isNaN(getStorageBroadcasterVolume)?volumeSliderAudio.value=volumeLabelAudio.innerHTML="1.00":volumeSliderAudio.value=volumeLabelAudio.innerHTML=getStorageBroadcasterVolume,listenerForVolumeSliderAudio[pid]=function(){!function(pid){var volumeSlider=document.getElementById(pid+"-volume-audio"),volume=parseFloat(volumeSlider.value).toFixed(2);document.getElementById(pid+"-volume-audio-label-value").innerHTML=volume,function(volumeMedia,item){if(volumeMedia<=1||volumeMedia>=0){var userVolumeMedia={pid:item,volume:volumeMedia};connection.socket.emit(connection.socketCustomEvent,{userVolumeMedia:userVolumeMedia})}}(volume,pid),sessionStorage.setItem("volume-for-broadcaster-"+pid,volume)}(pid)},volumeSliderAudio.addEventListener("change",listenerForVolumeSliderAudio[pid]),volumeSliderAudio.addEventListener("input",listenerForVolumeSliderAudio[pid]),volumeSliderAudio.style.display="",volumeLabelAudio.style.display="",document.getElementById(pid+"-volume-audio-label").style.display=""}else volumeLabelAudio.innerHTML="";listenerForReload[pid]=function(){!function(pid){sendReload(pid)}(pid)},(reload=document.getElementById(pid+"-reload")).addEventListener("click",listenerForReload[pid]),reload.style.color="orange",reconnect=document.getElementById(pid+"-reconnect"),listenerForReconnect[pid]=function(){!function(pid){sendReconnect(pid)}(pid)},reconnect.addEventListener("click",listenerForReconnect[pid]),reconnect.style.color="orange",closeConnect=document.getElementById(pid+"-close-connect"),listenerForCloseConnect[pid]=function(){!function(pid){sendCloseConnect(pid)}(pid)},closeConnect.addEventListener("click",listenerForCloseConnect[pid]),closeConnect.style.color="orange",quality=document.getElementById(pid+"-quality"),"Broadcaster"==role?(listenerForQuality[pid]=function(){!function(pid){sendParams(pid)}(pid)},quality.addEventListener("click",listenerForQuality[pid]),quality.style.color="orange"):quality.innerHTML="Can't send quality param";message=document.getElementById(pid+"-message"),"Broadcaster"==role||"Admin"==role?(listenerForMessage[pid]=function(){adminMessageHandler(pid)},message.addEventListener("click",listenerForMessage[pid]),message.style.color="orange"):message.innerHTML="Can't send message";if(audioStatusSwitch=document.getElementById(pid+"-switch"),"Broadcaster"==role){listenerForAudioStatus[pid]=function(){audioOnOffSwitch(pid)},audioStatusSwitch.addEventListener("change",listenerForAudioStatus[pid]),document.getElementById(pid+"-mic-controle").style.display="";var getStorageBroadcasterAudioStatus=parseFloat(sessionStorage.getItem("mic-for-broadcaster-"+pid));(!isNaN(getStorageBroadcasterAudioStatus)&&"1"==getStorageBroadcasterAudioStatus||1==document.getElementById("all-switch").checked)&&(audioStatusSwitch.checked=!0,audioOnOffSwitch(pid))}else audioStatusSwitch.innerHTML="";"Viewer"==role&&setTimeout(function(){Object.keys(userBackup).forEach(function(pid){"Broadcaster"==userBackup[pid]&&listenerForVolumeSliderAudio[pid]()})},2e3)}(pid,userBackup[pid])),userBackup[pid]!=usersArray[pid]&&(usersClosedHTML.appendChild(userControlsHTML[pid]),disableUserParams(pid,userBackup[pid]),delete userBackup[pid],userDeleteHandler(pid))})}).then(()=>{Object.keys(userBackup).forEach(function(pid){Object.keys(usersArray).indexOf(pid)<=-1&&(usersClosedHTML.appendChild(userControlsHTML[pid]),disableUserParams(pid,userBackup[pid]),delete userBackup[pid])}),setTimeout(allParticipantsHandler,2e3)})}}var listenerForVolumeSliderAudio=[],listenerForReload=[],listenerForReconnect=[],listenerForCloseConnect=[],listenerForQuality=[],listenerForMessage=[],listenerForAudioStatus=[],listenerForDeleteHandler=[];function disableUserParams(pid,role="Broadcaster"){if(isAdmin&&userControlsHTML[pid]){var userStatus=document.getElementById(pid);if(userStatus){DEBUG&&console.log("====user Delete HTML block=====",pid,role),userStatus.style="color:red; text-decoration:line-through; opacity:0.4",document.getElementById(pid+"-reload").removeEventListener("click",listenerForReload[pid]),document.getElementById(pid+"-reload").style="cursor:auto",delete listenerForReload[pid],document.getElementById(pid+"-reconnect").removeEventListener("click",listenerForReconnect[pid]),document.getElementById(pid+"-reconnect").style="cursor:auto",delete listenerForReconnect[pid],document.getElementById(pid+"-close-connect").removeEventListener("click",listenerForCloseConnect[pid]),document.getElementById(pid+"-close-connect").style="cursor:auto",delete listenerForCloseConnect[pid],"Broadcaster"!=role&&"Admin"!=role||(document.getElementById(pid+"-message").removeEventListener("click",listenerForMessage[pid]),document.getElementById(pid+"-message").style="cursor:auto",delete listenerForMessage[pid]),"Broadcaster"==role&&(document.getElementById(pid+"-quality").removeEventListener("click",listenerForQuality[pid]),document.getElementById(pid+"-quality").style="cursor:auto",document.getElementById(pid+"-switch").removeEventListener("click",listenerForAudioStatus[pid]),document.getElementById(pid+"-switch").disabled=!0,document.getElementById(pid+"-volume-audio").removeEventListener("change",listenerForVolumeSliderAudio[pid]),document.getElementById(pid+"-volume-audio").removeEventListener("input",listenerForVolumeSliderAudio[pid]),document.getElementById(pid+"-volume-audio").style="cursor:auto",delete listenerForQuality[pid],delete listenerForVolumeSliderAudio[pid],delete listenerForAudioStatus[pid],sessionStorage.removeItem("volume-for-broadcaster-"+pid),sessionStorage.removeItem("mic-for-broadcaster-"+pid));var userDelete=document.createElement("span");userDelete.style="color:black; text-decoration:none;",userDelete.setAttribute("id",pid+"-user-delete"),userDelete.innerHTML=" || Delete this",userStatus.appendChild(userDelete),listenerForDeleteHandler[pid]=function(){userDeleteHandler(pid)},document.getElementById(pid+"-user-delete").addEventListener("click",listenerForDeleteHandler[pid])}}}function userDeleteHandler(pid){document.getElementById(pid)&&(document.getElementById(pid+"-user-delete").removeEventListener("click",listenerForDeleteHandler[pid]),document.getElementById(pid).remove(),delete listenerForDeleteHandler[pid],delete userControlsHTML[pid])}function clearAdminUsersPanel(){[],Object.keys(userBackup).forEach(function(pid){disableUserParams(pid,userBackup[pid]),userDeleteHandler(pid),delete userBackup[pid]}),usersClosedHTML.innerHTML="",usersPanelHTML.innerHTML=""}function messageTextHandler(){}function adminMessageHandler(pid="all"){!function(message="",item="all"){var userAlert={pid:item,adminid:connection.userid,message:encodeURIComponent(message)};connection.socket.emit(connection.socketCustomEvent,{userAlert:userAlert})}(document.getElementById("message-input").value,pid)}function audioOnOffSwitch(pid="all"){document.getElementById(pid+"-switch").checked?(sendMuteAudio("0",pid),sessionStorage.setItem("mic-for-broadcaster-"+pid,1),"all"==pid&&Object.keys(userBackup).forEach(function(pid){"Broadcaster"===userBackup[pid]&&(document.getElementById(pid+"-switch").checked=!0,sessionStorage.setItem("mic-for-broadcaster-"+pid,1))})):(sendMuteAudio("1",pid),sessionStorage.setItem("mic-for-broadcaster-"+pid,0),"all"==pid&&Object.keys(userBackup).forEach(function(pid){"Broadcaster"===userBackup[pid]&&(document.getElementById(pid+"-switch").checked=!1,sessionStorage.setItem("mic-for-broadcaster-"+pid,0))}))}const scriptHarkHandler=document.createElement("script");scriptHarkHandler.src="/dist/hark.min.js",scriptHarkHandler.defer=!0,document.body.appendChild(scriptHarkHandler);var RMCMediaTrack={cameraStream:null,selfVideo:null,cameraVideoTrack:null,cameraAudioTrack:null,audioHandler:null,screen:null,preRecorededStream:null},RemoteMediaTrack={};function mute(e){connection.streamEvents.selectAll({local:!0}).forEach(function(stream){stream.stream.mute(e)}),localMicrophoneSignalVolume(0),hark(connection.attachStreams[0]).stop(),connection.onsilence({userid:connection.userid,volume:!0,threshold:!0})}function unmute(e){walkieTalkieModeEnable&&1==spacebarPressed||(connection.streamEvents.selectAll({local:!0}).forEach(function(stream){stream.stream.unmute(e)}),localMicrophoneSignalVolume(1),startHark())}function removeBrokenMediaContainers(){if(!isAdmin){var mediaContainersArray=[];connection.getAllParticipants().forEach(function(pid){1==connection.peers[pid].extra.broadcaster&&(mediaContainersArray[pid]=!0)}),Object.keys(RemoteMediaTrack).forEach(function(remoteUser){-1==Object.keys(mediaContainersArray).indexOf(remoteUser)&&connection.streamEvents.selectAll({userid:remoteUser}).forEach(function(streamEvent){connection.onleave(streamEvent),DEBUG&&console.log("removeBrokenMediaContainers. Remove stream",streamEvent)})}),setTimeout(removeBrokenMediaContainers,5e3)}}connection.videosContainer=document.getElementById("videos-container"),connection.videosContainer.setAttribute("style","font-size:0"),connection.onstream=function(event){if(statusHeaderHandler(),document.getElementById(event.userid)&&event.mediaElement)return event.mediaElement.pause(),event.mediaElement.srcObject=null,event.mediaElement.removeAttribute("src"),event.mediaElement.removeAttribute("srcObject"),event.mediaElement.muted=!0,event.mediaElement.volume=0,void delete event.mediaElement;event.mediaElement&&(event.mediaElement.removeAttribute("src"),event.mediaElement.removeAttribute("srcObject"),event.mediaElement.muted=!0,event.mediaElement.volume=0);var mediaElement=document.createElement(event.stream.getVideoTracks().length?"video":"audio");if(mediaElement.setAttribute("data-userid",event.userid),mediaElement.setAttribute("autoplay","autoplay"),mediaElement.setAttribute("playsinline",!0),mediaElement.setAttribute("controls",!0),mediaElement.setAttribute("poster",!0),mediaElement.poster="preload.png",mediaElement.addEventListener("mouseout",function(){mediaElement.classList.add("media-controls-disable"),"local"==event.type&&"default"==selectRotateVideo.value?mediaElement.classList.remove("media-controls-enable-rotate"):mediaElement.classList.remove("media-controls-enable")}),mediaElement.addEventListener("mouseover",function(){"local"==event.type&&"default"==selectRotateVideo.value?mediaElement.classList.add("media-controls-enable-rotate"):mediaElement.classList.add("media-controls-enable"),mediaElement.classList.remove("media-controls-disable")}),"local"===event.type||soundOff?(mediaElement.setAttribute("volume",0),mediaElement.volume=0,mediaElement.setAttribute("muted",!0),mediaElement.muted=!0):"remote"!==event.type||soundOff||(mediaElement.setAttribute("volume",1),mediaElement.volume=1,mediaElement.setAttribute("muted",!1),mediaElement.muted=!1),mediaElement.srcObject=event.stream,mediaElement.id=event.streamid,"local"===event.type&&("default"==selectRotateVideo.value?mediaElement.classList.add("local-video-rotate","media-controls-enable-rotate"):mediaElement.classList.add("media-controls-enable"),selectRotateVideo.onchange=function(){"rotate"==this.options[this.selectedIndex].value?mediaElement.classList.remove("local-video-rotate","media-controls-enable-rotate"):mediaElement.classList.add("local-video-rotate","media-controls-enable"),sessionStorage.setItem("rotate-video",this.value)},RMCMediaTrack.cameraStream=event.stream,cameraPermission&&"OFF"!=selectStreamQuality.value&&(RMCMediaTrack.cameraVideoTrack=event.stream.getVideoTracks()[0]),RMCMediaTrack.cameraAudioTrack=event.stream.getAudioTracks()[0],RMCMediaTrack.selfVideo=mediaElement,mediaElement.addEventListener("pause",mute),mediaElement.addEventListener("play",unmute),mediaElement.addEventListener("playing",function(){SpacebarToggleLocalMicrophone(),"pitch-shifter"==selectAudioHandling.value&&RMCMediaTrack.audioHandler?(stopAudioHandling(),setTimeout(function(){DEBUG&&console.log("startAudioHandling"),startAudioHandling()},2e3)):"pitch-shifter"!=selectAudioHandling.value||RMCMediaTrack.audioHandler||startAudioHandling(),startHark(),!connection.extra.roomInitiator&&connection.extra.broadcaster&&setTimeout(function(){autoStart=!0,params.quality=selectStreamQuality.value,changeLinksInRoomUrlsPanel("broadcaster",!1,!0)},1e3)})),"remote"===event.type){mediaElement.classList.add("media-controls-enable");var speechHarkHTML=document.createElement("div");speechHarkHTML.setAttribute("id","speechHark-"+event.userid),speechHarkHTML.className="speech-hark",RemoteMediaTrack[event.userid]=mediaElement;var graphBox=document.createElement("div");graphBox.id="graph-box-"+event.userid,graphBox.className="graph-box",graphBox.style.display="none",graphBox.innerHTML='<div class="graph-container" id="bitrateGraph-'+event.userid+'"><div>Bitrate</div><canvas id="bitrateCanvas-'+event.userid+'"></canvas></div><div class="graph-container" id="packetGraph-'+event.userid+'"><div>Packets sent per second</div><canvas id="packetCanvas-'+event.userid+'"></canvas></div>'}var mediacontainer=document.createElement("div");mediacontainer.className="media-container",mediacontainer.setAttribute("id",event.userid);var mediacontrols=document.createElement("div");mediacontrols.className="media-controls";var mediaBox=document.createElement("div");mediaBox.className="media-box";var h2=document.createElement("h2");h2.innerHTML=event.userid,"local"===event.type&&(h2.style.backgroundColor="#f17f5d",h2.title="local media");var span=document.createElement("span");span.className="media-box-informer",mediacontainer.appendChild(mediacontrols),mediacontrols.appendChild(span),"remote"===event.type&&mediacontrols.appendChild(graphBox),mediacontainer.appendChild(mediaBox),mediaBox.appendChild(h2),mediaBox.appendChild(mediaElement),speechHarkHTML&&mediaBox.appendChild(speechHarkHTML),connection.videosContainer.appendChild(mediacontainer),setTimeout(Resize,500)},connection.onmute=function(e){e.mediaElement&&(e.mediaElement.srcObject=null,e.mediaElement.setAttribute("poster","preload.png"),e.mediaElement.style.background="transparent url(preload.png) no-repeat center center")},connection.onunmute=function(e){e.mediaElement&&(e.mediaElement.hasAttribute("poster")&&(e.mediaElement.removeAttribute("poster"),e.mediaElement.removeAttribute("style")),e.mediaElement.srcObject=e.stream)},connection.onopen=function(event){var h2Initiator;DEBUG&&console.log("connection.onopen"),setTimeout(function(){document.getElementById(connection.userid)&&(h2Initiator=document.getElementById(connection.userid).querySelector("h2"))&&(h2Initiator.style.maxWidth=RMCMediaTrack.selfVideo.clientWidth+"px")},3e3),designer&&designer.pointsLength<=0&&setTimeout(function(){connection.send("plz-sync-points")},1e3)},connection.onstreamended=function(event){DEBUG&&console.info("connection.onstreamended user: ",event.userid,event);var videoElement=document.getElementById(event.streamid);videoElement&&(videoElement.pause(),videoElement.srcObject=null,videoElement.removeAttribute("src"),videoElement.load());var mediaElement=document.getElementById(event.userid);mediaElement&&mediaElement.parentNode&&(delete connection.streamEvents[event.streamid],mediaElement.parentNode.removeChild(mediaElement),setTimeout(Resize,500)),isView&&resetVideoStreamsForRecorder(event.streamid)},connection.onleave=function(event){DEBUG&&console.info("connection.onleave user: ",event.userid,event);var mediaElement=document.getElementById(event.userid);mediaElement&&mediaElement.parentNode&&(mediaElement.parentNode.removeChild(mediaElement),setTimeout(Resize,500)),RemoteMediaTrack[event.userid]&&delete RemoteMediaTrack[event.userid],connection.streamEvents.selectAll({userid:event.userid}).forEach(function(e){delete connection.streamEvents[e.streamid],isView&&connection.peers[event.userid]&&!0===connection.peers[event.userid].extra.broadcaster&&resetVideoStreamsForRecorder(e.streamid)}),setTimeout(afterReConnection,500)},connection.onNewParticipant=function(participantId,userPreferences){DEBUG&&console.log("onNewParticipant: new user in the room",participantId,"userPreferences",userPreferences),connection.extra.broadcaster&&!enableViewers&&userPreferences.connectionDescription.message.isOneWay?DEBUG&&console.warn("Disabled connect with Viewer",participantId):connection.acceptParticipationRequest(participantId,userPreferences),isView&&!userPreferences.connectionDescription.message.isOneWay&&connection.acceptParticipationRequest(participantId,userPreferences)};var disableAfterSocketDisconnectReconnect=!1,socketHandler=!1;function startHark(){!function(args){if(window.hark){var connection=args.connection,streamedObject={userid:connection.userid,volume:!0,threshold:!0},stream=args.stream;if(stream&&stream.getAudioTracks()[0]){var options=args.options,speechEvents=hark(stream,options);speechEvents.on("speaking",function(){connection.onspeaking(streamedObject)}),speechEvents.on("stopped_speaking",function(){connection.onsilence(streamedObject)})}}else DEBUG&&console.log("Please link hark.js")}({stream:connection.attachStreams[0],connection:connection,options:{interval:100,threshold:-90}})}function ToggleFullScreen(){if(connection.streamEvents.selectAll().length){var elem=document.getElementById("videos-container");document.fullscreenElement||document.mozFullScreenElement||document.webkitFullscreenElement?document.exitFullscreen():elem.requestFullscreen?elem.requestFullscreen():elem.mozRequestFullScreen?elem.mozRequestFullScreen():elem.webkitRequestFullscreen&&elem.webkitRequestFullscreen(elem.ALLOW_KEYBOARD_INPUT)}}function Resize(isAdd=!1){var elem=document.getElementById("videos-container"),settings=document.getElementById("room-settings"),roomUrls=document.getElementById("room-urls"),roomParams=document.getElementById("room-params"),menu=document.getElementById("menu"),bottom=document.getElementById("bottom"),drawcontainer=document.getElementById("draw-container"),filecontainer=document.getElementById("file-container"),additionalSettings=document.getElementById("additional-settings"),isFullScreeMode=document.webkitIsFullScreen||document.mozFullScreen||document.fullscreen,maxwidth=isFullScreeMode?window.innerWidth-5:window.innerWidth-100,maxheight=isFullScreeMode?window.innerHeight-5:window.innerHeight-(settings.clientHeight+additionalSettings.clientHeight+roomUrls.clientHeight+roomParams.clientHeight+menu.clientHeight+drawcontainer.clientHeight+filecontainer.clientHeight+bottom.clientHeight+10),isPortrait=!1;if(elem.hasChildNodes()){var children=elem.childNodes,childrenL=elem.childNodes.length,number=isAdd?childrenL+1:childrenL,cr=function(number,elem){var maxNumber,Columns=parseInt(window.innerWidth/240),Rows=parseInt(window.innerHeight/320),portrait=window.innerHeight>window.innerWidth;switch(number){case 3:maxNumber=3;break;case 4:case 7:maxNumber=4;break;case 17:maxNumber=6;default:maxNumber=Math.ceil(Math.sqrt(number))}return portrait?(Columns=Math.ceil(number/maxNumber),Rows=maxNumber):(Columns=maxNumber,Rows=Math.ceil(number/maxNumber)),{isPortrait:portrait,columns:Columns,rows:Rows}}(number),Columns=cr.columns,Rem=number%Columns,Rows=cr.rows,i=0;width=parseInt(maxwidth/cr.columns),height=maxheight/cr.rows,isPortrait=cr.isPortrait;for(var col,row=0;row<Rows;row++)for(row>0&&0!=Rem&&Columns-Rem>1&&Columns--,col=0;col<Columns&&i<childrenL;col++){var childStyle=children[i].style;childStyle.width=width+"px",childStyle.height=height+"px";var childNStyle=children[i].childNodes[1].style;childNStyle.width=width+"px",childNStyle.height=height+"px";var childNNStyle=children[i].childNodes[1].childNodes[1].style;if(childNNStyle.width=width+"px",childNNStyle.height=height+"px",isPortrait){elem.style.height=maxheight+"px",elem.style.width=maxwidth+"px",childStyle.minWidth=width+"px",childStyle.maxHeight=height+"px",childStyle.removeAttribute?(childStyle.removeAttribute("max-width"),childStyle.removeAttribute("min-height")):(childStyle.removeProperty("max-width"),childStyle.removeProperty("min-height"));children[i].childNodes[1].style;childNStyle.minWidth=width+"px",childNStyle.maxHeight=height+"px",childNStyle.removeAttribute?(childNStyle.removeAttribute("max-width"),childNStyle.removeAttribute("min-height")):(childNStyle.removeProperty("max-width"),childNStyle.removeProperty("min-height")),childNNStyle.minWidth=width+"px",childNNStyle.maxHeight=height+"px",childNNStyle.removeAttribute?(childNNStyle.removeAttribute("max-width"),childNNStyle.removeAttribute("min-height")):(childNNStyle.removeProperty("max-width"),childNNStyle.removeProperty("min-height"))}else elem.style.height=maxheight+"px",elem.style.width=maxwidth+"px",childStyle.maxWidth=width+"px",childStyle.minHeight=height+"px",childStyle.removeAttribute?(childStyle.removeAttribute("min-width"),childStyle.removeAttribute("max-height")):(childStyle.removeProperty("min-width"),childStyle.removeProperty("max-height")),childNStyle.maxWidth=width+"px",childNStyle.minHeight=height+"px",childNStyle.removeAttribute?(childNStyle.removeAttribute("min-width"),childNStyle.removeAttribute("max-height")):(childNStyle.removeProperty("min-width"),childNStyle.removeProperty("max-height")),childNNStyle.maxWidth=width+"px",childNNStyle.minHeight=height+"px",childNNStyle.removeAttribute?(childNNStyle.removeAttribute("min-width"),childNNStyle.removeAttribute("max-height")):(childNNStyle.removeProperty("min-width"),childNNStyle.removeProperty("max-height"));i++}}else var width=maxwidth/2,height=maxheight/2;Object.keys(document.querySelectorAll("h2")).forEach(function(pid){isAdmin||0==connection.streamEvents.selectAll().length||(document.querySelectorAll("h2")[pid].style.maxWidth=width+"px",document.querySelectorAll("h2")[pid].style.maxHeight=height+"px")});var chatTextarea=document.createElement("textarea"),chatBox=document.createElement("div");return chatTextarea&&(chatTextarea.style.width=chatBox.style.width=width+"px"),chatBox&&(chatBox.style.height=height-chatTextarea.clientHeight+"px"),{width:width,height:height,isPortrait:isPortrait}}connection.onSocketDisconnect=function(event){DEBUG&&console.warn("socket.io connection is closed. Status: ",event),statusHeaderHandler(mess="Signal server connection is closed"),1!=reconnectStatus&&1!=disableAfterSocketDisconnectReconnect&&(socketHandler=!0,connection.getAllParticipants().forEach(function(pid){connection.disconnectWith(pid)}))},connection.onUserIdAlreadyTaken=function(useridAlreadyTaken,yourNewUserId){DEBUG&&console.warn("Userid already taken.",useridAlreadyTaken,"Your new userid:",yourNewUserId),connection.close(),connection.closeSocket()},connection.onExtraDataUpdated=function(event){event.extra&&event.extra.roomInitiator&&(enableAdmins=!0===event.extra.adminEnableStatus,enableAdminsHandler(),enableViewers=!0===event.extra.viewerEnableStatus,enableViewersHandler())},connection.onMediaError=function(error,constraints){DEBUG&&console.log("onMediaError:"+JSON.stringify(error,null,"\t"),constraints),mess="Browser Error:\n\n"+error+JSON.stringify(constraints,null,"\t"),mess+=DetectRTC.hasMicrophone?"":"\nIs a microphone connected? ",mess+=DetectRTC.isWebsiteHasMicrophonePermissions?"":"\nIs access to the Microphone? ",statusHeaderHandler(mess+=cameraPermission?"":"\nIs access to the Camera? ",0,"red"),connection.closeSocket()},connection.onmessage=function(event){if(!isAdmin&&!isView){if(event.userid&&event.data.userMessage&&(document.getElementById("text-chat").onclick(),appendDIV(event.userid,event.data.userMessage)),"plz-sync-points"===event.data)return designer||document.getElementById("draw").onclick(),void designer.sync();event.data.designerMessage&&(designer||document.getElementById("draw").onclick(),designer.syncData(event.data.designerMessage),getDataURL())}},connection.onspeaking=function(e){var userOnSpeaking={pid:e.userid,speaking:!0};try{connection.socket.emit(connection.socketCustomEvent,{userOnSpeaking:userOnSpeaking})}catch(e){}},connection.onsilence=function(e){var userOnSilence={pid:e.userid,silent:!0};try{connection.socket.emit(connection.socketCustomEvent,{userOnSilence:userOnSilence})}catch(e){}},connection.onvolumechange=function(e){var userOnVolumechange={pid:e.userid,volume:e.volume};try{connection.socket.emit(connection.socketCustomEvent,{userOnVolumechange:userOnVolumechange})}catch(e){}},document.getElementById("full-screen").onclick=ToggleFullScreen,document.body.onresize=function(e){setTimeout(Resize,500)};const scriptTimeLineGraphView=document.createElement("script");scriptTimeLineGraphView.src="/dist/graph.min.js",scriptTimeLineGraphView.defer=!0,document.body.appendChild(scriptTimeLineGraphView);const scriptGetStats=document.createElement("script");scriptGetStats.src="/dist/getStats.min.js",scriptGetStats.defer=!0,document.body.appendChild(scriptGetStats);var statsOn=!1;document.getElementById("stats-info-off").onclick=function(){0!=connection.streamEvents.selectAll().length&&(isAdmin||(this.style.display="none",document.getElementById("stats-info-on").style.display="",statsOn=!0))},document.getElementById("stats-info-on").style.display="none",document.getElementById("stats-info-on").onclick=function(){this.style.display="none",document.getElementById("stats-info-off").style.display="",statsOn=!1},connection.onPeerStateChanged=function(event){if(!isAdmin&&"connected"===event.iceConnectionState&&"stable"===event.signalingState){if(!0===connection.peers[event.userid].gettingStats)return;connection.peers[event.userid].gettingStats=!0;var peer=connection.peers[event.userid].peer;"Firefox"===DetectRTC.browser.name?getStats(peer,peer.getLocalStreams()[0].getTracks()[0],function(stats){onGettingWebRTCStats(stats,event.userid)},1e3):getStats(peer,function(stats){onGettingWebRTCStats(stats,event.userid)},1e3)}};var timeNow,timeTotal,chatContainer,chatTextarea,chatBox,bitrateGraph=[],bitrateSeries=[],packetGraph=[],packetSeries=[],lastResult=[],timeStart=+new Date;function onGettingWebRTCStats(stats,remoteUserId){if(isAdmin&&stats.nomore(),statsOn){connection.peers[remoteUserId]||stats.nomore(),timeNow=+new Date,timeTotal=Math.floor(-1*(timeStart-timeNow)/1e3);var statsData="\n";statsData+="Current time: "+time(),statsData+="\n",statsData+="Connection time from start: "+timeFormat(timeTotal),statsData+="\n",reconnectCounter>0&&(statsData+="The number of local reconnections: "+reconnectCounter,statsData+="\n"),statsData+="Bandwidth sent: "+bitesToSize(stats.bandwidth.speed),statsData+="\n",statsData+="Bandwidth audio send: "+bitesToSize(stats.audio.send.availableBandwidth),statsData+="\n",statsData+="Bandwidth audio recv: "+bitesToSize(stats.audio.recv.availableBandwidth),statsData+="\n",statsData+="Bandwidth video send: "+bitesToSize(stats.video.send.availableBandwidth),statsData+="\n",statsData+="Bandwidth video recv: "+bitesToSize(stats.video.recv.availableBandwidth),statsData+="\n",statsData+="Encryption: "+stats.encryption,statsData+="\n",statsData+="Codecs: "+stats.audio.recv.codecs.concat(stats.video.recv.codecs).join(", "),statsData+="\n",statsData+="Data Received: "+bytesToSize(stats.audio.bytesReceived+stats.video.bytesReceived),statsData+="\n",statsData+="ICE loc: "+stats.connectionType.local.candidateType.join(", ")+". IP: "+stats.connectionType.local.ipAddress.join(", ")+"?transport="+stats.connectionType.local.transport.join(", "),statsData+="\n",statsData+="ICE rem: "+stats.connectionType.remote.candidateType.join(", ")+". IP: "+stats.connectionType.remote.ipAddress.join(", ")+"?transport="+stats.connectionType.remote.transport.join(", "),statsData+="\n",statsData+="resol recv: "+stats.resolutions.recv.width+"x"+stats.resolutions.recv.height,statsData+="\n",statsData+="resol sent: "+stats.resolutions.send.width+"x"+stats.resolutions.send.height,connection.streamEvents.selectAll({userid:remoteUserId}).forEach(function(streamEvent){streamEvent&&(statsData+="\n",statsData+="AudioTracks res id: "+streamEvent.stream.getAudioTracks()[0].id)}),connection.streamEvents.selectAll({userid:connection.userid}).forEach(function(streamEvent){streamEvent&&(statsData+="\n",statsData+="AudioTracks send id: "+streamEvent.stream.getAudioTracks()[0].id)});var remoteUserDIV=document.getElementById(remoteUserId);if(remoteUserDIV){var statsInformer=remoteUserDIV.querySelector("span");statsInformer.innerHTML=statsData.replace(/\n/g,"<br>"),statsInformer.style.maxWidth=RemoteMediaTrack[remoteUserId].clientWidth+"px",connection.peers[remoteUserId].peer.getSenders().forEach(function(rtpSender){rtpSender&&rtpSender.track&&"video"==rtpSender.track.kind&&(bitrateSeries[remoteUserId]||(bitrateSeries[remoteUserId]=new TimelineDataSeries,bitrateGraph[remoteUserId]=new TimelineGraphView("bitrateGraph-"+remoteUserId,"bitrateCanvas-"+remoteUserId),bitrateGraph[remoteUserId].updateEndDate(),packetSeries[remoteUserId]=new TimelineDataSeries,packetGraph[remoteUserId]=new TimelineGraphView("packetGraph-"+remoteUserId,"packetCanvas-"+remoteUserId),packetGraph[remoteUserId].updateEndDate()),document.getElementById("graph-box-"+remoteUserId).style.display="",document.getElementById("graph-box-"+remoteUserId).style.width=RemoteMediaTrack[remoteUserId].clientWidth+"px",rtpSender.getStats().then(res=>{res.forEach(report=>{let bytes,packets;const now=report.timestamp;if("outbound-rtp"===report.type&&(bytes=report.bytesSent,packets=report.packetsSent,lastResult[remoteUserId]&&lastResult[remoteUserId].has(report.id))){const bitrate=8*(bytes-lastResult[remoteUserId].get(report.id).bytesSent)/(now-lastResult[remoteUserId].get(report.id).timestamp);bitrateSeries[remoteUserId].addPoint(now,bitrate),bitrateGraph[remoteUserId].setDataSeries([bitrateSeries[remoteUserId]]),bitrateGraph[remoteUserId].updateEndDate(),packetSeries[remoteUserId].addPoint(now,packets-lastResult[remoteUserId].get(report.id).packetsSent),packetGraph[remoteUserId].setDataSeries([packetSeries[remoteUserId]]),packetGraph[remoteUserId].updateEndDate()}}),lastResult[remoteUserId]=res}))})}}else document.getElementById(remoteUserId)&&(document.getElementById(remoteUserId).querySelector("span").innerHTML="",document.getElementById("graph-box-"+remoteUserId).style.display="none")}function bytesToSize(bytes){if(0===bytes)return"0 Bytes";var i=parseInt(Math.floor(Math.log(bytes)/Math.log(1e3)),10);return(bytes/Math.pow(1e3,i)).toPrecision(3)+" "+["Bytes","KB","MB","GB","TB"][i]}function bitesToSize(bytes){if(0===bytes)return"0 Bites";bytes*=8;var i=parseInt(Math.floor(Math.log(bytes)/Math.log(1024)),10);return(bytes/Math.pow(1024,i)).toPrecision(3)+" "+["bites/s","kbs","mbs","gbs","tbs"][i]}function timeFormat(time){var hrs=~~(time/3600),mins=~~(time%3600/60),secs=~~time%60,ret="";return hrs>0&&(ret+=hrs+":"+(mins<10?"0":"")),ret+=mins+":"+(secs<10?"0":""),ret+=""+secs}document.getElementById("text-chat").onclick=function(){0!=connection.streamEvents.selectAll().length&&(this.style.display="none",document.getElementById("stop-text-chat").style.display="",function(){chatContainer?(chatTextarea.style.display="",chatBox.style.display=""):(chatContainer=document.getElementById(connection.userid).querySelector("span"),(chatTextarea=document.createElement("textarea")).id="input-text-chat",chatTextarea.title="To resise pull the corner",chatTextarea.placeholder="\nChat. Press Enter to send",chatContainer.appendChild(chatTextarea),(chatBox=document.createElement("div")).className="chat-output",chatContainer.appendChild(chatBox),checkChatContainerUI());chatTextarea.style.width=chatBox.style.width=RMCMediaTrack.selfVideo.clientWidth+"px",chatTextarea.focus(),chatTextarea.onkeyup=function(e){if(13==e.keyCode){if(e.shiftKey)return;if(!connection.getAllParticipants().length)return;if(this.value=this.value.replace(/^\s+|\s+$/g,""),this.value=encodeURIComponent(this.value),!this.value.length)return;var chatMessage=this.value;isView||connection.send({userMessage:chatMessage}),isView||appendDIV("My",chatMessage),this.value=""}}}())},document.getElementById("stop-text-chat").style.display="none",document.getElementById("stop-text-chat").onclick=function(){this.style.display="none",document.getElementById("text-chat").style.display="",function(){if(!connection.streamEvents.selectAll().length||!chatTextarea)return;chatTextarea.style.display="none",chatBox.style.display="none"}()};var chatTabIndex=1;function appendDIV(sender,message){if(message&&sender&&chatBox){var div=document.createElement("div");div.className="chat-messages",div.innerHTML='<a href="#" style="color:black" title="'+new Date+'">'+sender+"</a>: "+decodeURIComponent(message),div.tabIndex=chatTabIndex,chatTabIndex++,chatBox.appendChild(div),chatTextarea.style.width=chatBox.style.width=RMCMediaTrack.selfVideo.clientWidth+"px",chatBox.style.height=RMCMediaTrack.selfVideo.clientHeight-chatTextarea.clientHeight+"px",chatBox.scrollTop=chatBox.scrollHeight,chatTextarea.focus()}}var ifChatContainerisNull=!1;function checkChatContainerUI(){document.getElementById(connection.userid)||(ifChatContainerisNull=!0),document.getElementById(connection.userid)&&1==ifChatContainerisNull&&(ifChatContainerisNull=!1,setTimeout(function(){document.getElementById(connection.userid).querySelector("span").appendChild(chatContainer),chatTextarea.style.width=chatBox.style.width=RMCMediaTrack.selfVideo.clientWidth+"px",chatBox.style.height=RMCMediaTrack.selfVideo.clientHeight-chatTextarea.clientHeight+"px"},500)),setTimeout(checkChatContainerUI,3e3)}var selectAudioHandling=document.getElementById("audio-handling");sessionStorage.getItem("audioHandling")?selectAudioHandling.value=sessionStorage.getItem("audioHandling"):sessionStorage.setItem("audioHandling",selectAudioHandling.value);var audioContext,jungle,peerTrack,gainNode,oldwalkieTalkieMode,shiftSlider=document.getElementById("shiftSlider"),shiftSliderTextValue=document.getElementById("shiftSliderTextValue");function AudioHandlingToggle(item){sessionStorage.setItem("audioHandling",selectAudioHandling.value),sessionStorage.setItem("shiftSliderTextValue",shiftSliderTextValue.value),!isView&&DetectRTC.isAudioContextSupported&&DetectRTC.isCreateMediaStreamSourceSupported&&("pitch-shifter"==item?(shiftSliderTextValue.style.display=shiftSlider.style.display="",RMCMediaTrack.cameraStream&&startAudioHandling()):(shiftSliderTextValue.style.display=shiftSlider.style.display="none",RMCMediaTrack.cameraStream&&stopAudioHandling()))}function replaceAudioTrack(audioTrack){audioTrack&&("ended"!==audioTrack.readyState?connection.getAllParticipants().forEach(function(pid){var peer=connection.peers[pid].peer;if(peer.getSenders){var trackToReplace=audioTrack;peer.getSenders().forEach(function(sender){sender&&sender.track&&"audio"===sender.track.kind&&trackToReplace&&(sender.replaceTrack(trackToReplace),trackToReplace=null)})}}):DEBUG&&console.log('Can not replace an "ended" track. track.readyState: '+audioTrack.readyState))}function stopAudioHandling(){null!=RMCMediaTrack.audioHandler&&"live"==RMCMediaTrack.cameraStream.getAudioTracks()[0].readyState&&(null==RMCMediaTrack.cameraVideoTrack?(RMCMediaTrack.selfVideo.srcObject=RMCMediaTrack.cameraStream,replaceAudioTrack(RMCMediaTrack.cameraAudioTrack)):(RMCMediaTrack.cameraStream.getAudioTracks().forEach(function(track){RMCMediaTrack.cameraStream.removeTrack(track)}),RMCMediaTrack.cameraStream.addTrack(RMCMediaTrack.cameraAudioTrack),RMCMediaTrack.selfVideo.srcObject=RMCMediaTrack.cameraStream,replaceAudioTrack(RMCMediaTrack.cameraAudioTrack),connection.attachStreams=[RMCMediaTrack.cameraStream]),RMCMediaTrack.audioHandler=null,window.audioContext&&audioContext.close().then(function(){window.audioContext=null,window.jungle=null}))}function localMicrophoneSignalVolume(e=1){if(audioContext)return gainNode.gain.value=e}function startAudioHandling(){if(RMCMediaTrack.cameraStream&&!RMCMediaTrack.audioHandler){walkieTalkieModeEnable&&(oldwalkieTalkieMode=walkieTalkieModeEnable,walkieTalkieModeEnable=!1,SpacebarToggleLocalMicrophone()),audioContext||(audioContext=new AudioContext);var mediaStreamSource=audioContext.createMediaStreamSource(RMCMediaTrack.cameraStream);peerTrack=audioContext.createMediaStreamDestination();var delay=audioContext.createDelay();delay.delayTime.value=0,mediaStreamSource.connect(delay),(gainNode=audioContext.createGain()).gain.value=localMicrophoneSignalVolume(),delay.connect(gainNode),window.jungle||(jungle=new Jungle(audioContext)),jungle.setPitchOffset(shiftSliderTextValue.value),gainNode.connect(jungle.input),jungle.output.connect(peerTrack),RMCMediaTrack.audioHandler=peerTrack.stream.getAudioTracks()[0],null==RMCMediaTrack.cameraVideoTrack?(DEBUG&&console.log("cameraVideoTrack is null"),connection.attachStreams=[peerTrack.stream],replaceAudioTrack(RMCMediaTrack.audioHandler)):connection.attachStreams.forEach(function(stream){stream.getAudioTracks().forEach(function(track){stream.removeTrack(track)}),stream.addTrack(RMCMediaTrack.audioHandler)}),oldwalkieTalkieMode&&(walkieTalkieModeEnable=!0,SpacebarToggleLocalMicrophone())}replaceAudioTrack(RMCMediaTrack.audioHandler)}function createDelayTimeBuffer(context,activeTime,fadeTime,shiftUp){for(var length1=activeTime*context.sampleRate,length=length1+(activeTime-2*fadeTime)*context.sampleRate,buffer=context.createBuffer(1,length,context.sampleRate),p=buffer.getChannelData(0),i=0;i<length1;++i)p[i]=shiftUp?(length1-i)/length:i/length1;for(i=length1;i<length;++i)p[i]=0;return buffer}"pitch-shifter"==selectAudioHandling.value?shiftSliderTextValue.style.display=shiftSlider.style.display="":shiftSliderTextValue.style.display=shiftSlider.style.display="none",sessionStorage.getItem("shiftSliderTextValue")?shiftSlider.value=shiftSliderTextValue.value=parseFloat(sessionStorage.getItem("shiftSliderTextValue")).toFixed(2):shiftSlider.value=shiftSliderTextValue.value="-0.35",selectAudioHandling.onchange=function(){AudioHandlingToggle(selectAudioHandling.value)};var delayTime=.1,fadeTime=.05,bufferTime=.1;function Jungle(context){this.context=context;var input=context.createGain(),output=context.createGain();this.input=input,this.output=output;var mod1=context.createBufferSource(),mod2=context.createBufferSource(),mod3=context.createBufferSource(),mod4=context.createBufferSource();this.shiftDownBuffer=createDelayTimeBuffer(context,bufferTime,fadeTime,!1),this.shiftUpBuffer=createDelayTimeBuffer(context,bufferTime,fadeTime,!0),mod1.buffer=this.shiftDownBuffer,mod2.buffer=this.shiftDownBuffer,mod3.buffer=this.shiftUpBuffer,mod4.buffer=this.shiftUpBuffer,mod1.loop=!0,mod2.loop=!0,mod3.loop=!0,mod4.loop=!0;var mod1Gain=context.createGain(),mod2Gain=context.createGain(),mod3Gain=context.createGain();mod3Gain.gain.value=0;var mod4Gain=context.createGain();mod4Gain.gain.value=0,mod1.connect(mod1Gain),mod2.connect(mod2Gain),mod3.connect(mod3Gain),mod4.connect(mod4Gain);var modGain1=context.createGain(),modGain2=context.createGain(),delay1=context.createDelay(),delay2=context.createDelay();mod1Gain.connect(modGain1),mod2Gain.connect(modGain2),mod3Gain.connect(modGain1),mod4Gain.connect(modGain2),modGain1.connect(delay1.delayTime),modGain2.connect(delay2.delayTime);var fade1=context.createBufferSource(),fade2=context.createBufferSource(),fadeBuffer=function(context,activeTime,fadeTime){for(var length1=activeTime*context.sampleRate,length=length1+(activeTime-2*fadeTime)*context.sampleRate,buffer=context.createBuffer(1,length,context.sampleRate),p=buffer.getChannelData(0),fadeLength=fadeTime*context.sampleRate,fadeIndex1=fadeLength,fadeIndex2=length1-fadeLength,i=0;i<length1;++i){var value;value=i<fadeIndex1?Math.sqrt(i/fadeLength):i>=fadeIndex2?Math.sqrt(1-(i-fadeIndex2)/fadeLength):1,p[i]=value}for(i=length1;i<length;++i)p[i]=0;return buffer}(context,bufferTime,fadeTime);fade1.buffer=fadeBuffer,fade2.buffer=fadeBuffer,fade1.loop=!0,fade2.loop=!0;var mix1=context.createGain(),mix2=context.createGain();mix1.gain.value=0,mix2.gain.value=0,fade1.connect(mix1.gain),fade2.connect(mix2.gain),input.connect(delay1),input.connect(delay2),delay1.connect(mix1),delay2.connect(mix2),mix1.connect(output),mix2.connect(output);var t=context.currentTime+.05,t2=t+bufferTime-fadeTime;mod1.start(t),mod2.start(t2),mod3.start(t),mod4.start(t2),fade1.start(t),fade2.start(t2),this.mod1=mod1,this.mod2=mod2,this.mod1Gain=mod1Gain,this.mod2Gain=mod2Gain,this.mod3Gain=mod3Gain,this.mod4Gain=mod4Gain,this.modGain1=modGain1,this.modGain2=modGain2,this.fade1=fade1,this.fade2=fade2,this.mix1=mix1,this.mix2=mix2,this.delay1=delay1,this.delay2=delay2,this.setDelay(delayTime)}function sendParams(item="all"){var userQualityParams={quality:selectStreamQuality.value,bandwidth:selectBandwidth.value,audiohandling:selectAudioHandling.value,audiohandlingShiftSliderValue:shiftSlider.value,transportPolicy:transportPolicyHTML.value,enableviewers:enableViewers,enableadmins:enableAdmins,walkietalkie:walkieTalkieModeEnable,roomParticipantsNumber:setParticipants,rotatevideo:selectRotateVideo.value,displayaspectRatio:aspectRatio.value,displayframeRate:frameRate.value,displaycursor:cursor.value};userQualityParams.pid="all"!=item?item:"all",connection.socket.emit(connection.socketCustomEvent,{userQualityParams:userQualityParams}),statusHeaderHandler(mess="Send Settings to "+userQualityParams.pid,3e3)}function sendReconnect(item="all"){if(0!=window.confirm('Please select "OK" to confirm Reconnect for '+item.toUpperCase()+" user")){var userReconnect={pid:item};connection.socket.emit(connection.socketCustomEvent,{userReconnect:userReconnect})}}function sendCloseConnect(item="all"){if(0!=window.confirm('Please select "OK" to confirm Close Connect for '+item.toUpperCase()+" user")){var userCloseConnect={pid:item};connection.socket.emit(connection.socketCustomEvent,{userCloseConnect:userCloseConnect})}}function sendReload(item="all"){if(0!=window.confirm('Please select "OK" to confirm Reload for '+item.toUpperCase()+" user")){var userReload={pid:item};connection.socket.emit(connection.socketCustomEvent,{userReload:userReload})}}function sendMuteAudio(volume="0",item="all"){var userMuteAudio={pid:item,volume:volume};connection.socket.emit(connection.socketCustomEvent,{userMuteAudio:userMuteAudio})}function afterConnectingSocket(){connection.socket.on(connection.socketCustomEvent,function(message){if(message.userOnVolumechange&&document.getElementById("speechHark-"+message.userOnVolumechange.pid)){var size=Math.round(1e3/Math.round(message.userOnVolumechange.volume)*-1+2);document.getElementById("speechHark-"+message.userOnVolumechange.pid).style.width=size+"px",isAdmin||(document.getElementById("speechHark-"+message.userOnVolumechange.pid).style.height=size+"px")}if(message.userOnSilence){var setSpeechHarkOnSilenceUI=document.getElementById("speechHark-"+message.userOnSilence.pid);setSpeechHarkOnSilenceUI&&(setSpeechHarkOnSilenceUI.style.backgroundColor="grey",setSpeechHarkOnSilenceUI.style.width=setSpeechHarkOnSilenceUI.style.height="20px"),isAdmin&&document.getElementById(message.userOnSilence.pid)&&(document.getElementById(message.userOnSilence.pid).style.backgroundColor="#ffffff")}if(message.userOnSpeaking){var setSpeechHarkOnSpeakingUI=document.getElementById("speechHark-"+message.userOnSpeaking.pid);setSpeechHarkOnSpeakingUI&&(setSpeechHarkOnSpeakingUI.style.backgroundColor="#ff9b00",setSpeechHarkOnSpeakingUI.style.width=setSpeechHarkOnSpeakingUI.style.height="20px"),isAdmin&&document.getElementById(message.userOnSpeaking.pid)&&(document.getElementById(message.userOnSpeaking.pid).style.backgroundColor="oldlace")}if(message.userMuteAudio&&!isView&&!isAdmin){if(!connection.extra.adminEnableStatus)return;(connection.extra.broadcaster&&connection.userid==message.userMuteAudio.pid||"all"==message.userMuteAudio.pid)&&(0==message.userMuteAudio.volume&&mute("audio"),1==message.userMuteAudio.volume&&unmute("audio"),localMicrophoneSignalVolume(message.userMuteAudio.volume),DEBUG&&console.log("==== userMuteAudio command from Admin ===== ",1==message.userMuteAudio.volume?"on":"off"))}if(message.userAlert&&!isView){if(!connection.extra.adminEnableStatus)return;connection.userid!=message.userAlert.pid&&"all"!=message.userAlert.pid||(statusHeaderHandler(mess=decodeURIComponent(message.userAlert.message)+'<br /><p style="font-size:10px;"><i>(Message from Admin '+message.userAlert.adminid+")</i></p>",1e4),DEBUG&&console.log("==== userAlert command from Admin =====",message.userAlert.adminid))}if(message.userQualityParams&&!isView&&!isAdmin){if(!connection.extra.adminEnableStatus)return;message.userQualityParams.pid.trim()!=connection.userid&&"all"!=message.userQualityParams.pid||(Object.keys(libConstraints).includes(message.userQualityParams.quality)&&cameraPermission&&selectStreamQuality.value!=message.userQualityParams.quality&&(selectStreamQuality.value=message.userQualityParams.quality,selectStreamQuality.onchange()),Object.keys(libBandwidth).includes(message.userQualityParams.bandwidth)&&selectBandwidth.value!=message.userQualityParams.bandwidth&&(selectBandwidth.value=message.userQualityParams.bandwidth,selectBandwidth.onchange()),"pitch-shifter"!=message.userQualityParams.audiohandling&&"default"!=message.userQualityParams.audiohandling||(selectAudioHandling.value=message.userQualityParams.audiohandling,shiftSliderTextValue.value=shiftSlider.value=message.userQualityParams.audiohandlingShiftSliderValue,AudioHandlingToggle(selectAudioHandling.value)),"default"!==message.userQualityParams.transportPolicy&&"stun"!==message.userQualityParams.transportPolicy&&"turn"!==message.userQualityParams.transportPolicy&&"google"!==message.userQualityParams.transportPolicy||transportPolicyHTML.value!=message.userQualityParams.transportPolicy&&(transportPolicyHTML.value=message.userQualityParams.transportPolicy,transportPolicyHTML.onchange()),message.userQualityParams.roomParticipantsNumber&&(MaxParticipantsNumber.value=sanitizeIntParams(message.userQualityParams.roomParticipantsNumber)),!0!==message.userQualityParams.enableviewers&&!1!==message.userQualityParams.enableviewers||(enableViewers=message.userQualityParams.enableviewers,enableViewersHandler()),!0!==message.userQualityParams.enableadmins&&!1!==message.userQualityParams.enableadmins||(enableAdmins=message.userQualityParams.enableadmins,enableAdminsHandler()),!0!==message.userQualityParams.walkietalkie&&!1!==message.userQualityParams.walkietalkie||(walkieTalkieModeEnable=message.userQualityParams.walkietalkie,SpacebarToggleLocalMicrophone()),"default"!==message.userQualityParams.rotatevideo&&"rotate"!==message.userQualityParams.rotatevideo||(selectRotateVideo.value=message.userQualityParams.rotatevideo,selectRotateVideo.onchange()),message.userQualityParams.displayaspectRatio&&(aspectRatio.value=message.userQualityParams.displayaspectRatio,aspectRatio.onchange()),message.userQualityParams.displayframeRate&&(frameRate.value=message.userQualityParams.displayframeRate,frameRate.onchange()),message.userQualityParams.displaycursor&&(cursor.value=message.userQualityParams.displaycursor,cursor.onchange()),changeLinksInRoomUrlsPanel("broadcaster",!1,!0),DEBUG&&console.log("==== userQualityParams command from Admin ===== "))}if(message.userVolumeMedia&&isView&&!soundOff){if(!connection.extra.adminEnableStatus)return;RemoteMediaTrack[message.userVolumeMedia.pid]&&(RemoteMediaTrack[message.userVolumeMedia.pid].volume=message.userVolumeMedia.volume)}if(message.userCloseConnect){if(!connection.extra.adminEnableStatus)return;message.userCloseConnect.pid.trim()!=connection.userid&&"all"!=message.userCloseConnect.pid||(DEBUG&&console.log("==== userCloseConnect command from Admin ===== "),setTimeout(function(){isAdmin?(statusHeaderHandler(mess="Stop admin mode"),connection.getAllParticipants().forEach(function(p){connection.disconnectWith(p)}),clearAdminUsersPanel(),adminMessageContainerHTML.innerHTML=usresHTML.innerHTML=usersPanelHTML.innerHTML=""):isView?(statusHeaderHandler(mess="Stop view mode"),connection.getAllParticipants().forEach(function(p){connection.peers[p].peer.getRemoteStreams().forEach(function(stream){stream.stop()}),connection.disconnectWith(p)}),connection.videosContainer.remove()):(statusHeaderHandler(mess="Stop broadcaster mode"),connection.getAllParticipants().forEach(function(p){connection.attachStreams.forEach(function(stream){connection.peers[p].peer.removeStream(stream)}),connection.disconnectWith(p)}),connection.attachStreams.forEach(function(stream){stream.stop()})),setTimeout(function(){disableAfterSocketDisconnectReconnect=!0,connection.close(),connection.closeSocket(),buttonOpenjoin.onclick=connection.join=connection.open=connection.onstream=removeBrokenMediaContainers=function(){}},500)},500))}if(message.userReload){if(!connection.extra.adminEnableStatus)return;message.userReload.pid.trim()!=connection.userid&&"all"!=message.userReload.pid||(DEBUG&&console.log("==== userReload command from Admin ===== "),connection.extra.broadcaster&&changeLinksInRoomUrlsPanel("broadcaster",!1,!0),setTimeout(function(){location.reload()},Math.floor(1500*Math.random())+1e3))}if(message.newRoom){if(!connection.extra.adminEnableStatus)return;if(connection.extra.viewer)return;DEBUG&&console.log("==== newRoom command from Admin ===== "),newroom=message.newRoom,roomid=document.getElementById("room-id").value=newroom.replace(/[^а-яА-ЯёЁA-Za-z0-9]+/g,""),reSetRoomLinks(),DEBUG&&console.log("Command from Admin: change roomid ",roomid),connection.getAllParticipants().forEach(function(pid){connection.disconnectWith(pid)}),setTimeout(function(){connection.close(),connection.closeSocket()},Math.floor(1e3*Math.random())+500)}var newroom;if(message.userReconnect){if(!connection.extra.adminEnableStatus)return;message.userReconnect.pid.trim()!=connection.userid&&"all"!=message.userReconnect.pid||setTimeout(function(){connection.getAllParticipants().forEach(function(pid){connection.disconnectWith(pid)}),connection.extra.broadcaster&&changeLinksInRoomUrlsPanel("broadcaster",!1,!0),setTimeout(function(){connection.close(),connection.closeSocket(),DEBUG&&console.log("==== userReconnect command from Admin ===== ")},Math.floor(1e3*Math.random())+500)},1e3)}if(message.userRenegotiate){if(!connection.extra.adminEnableStatus)return;message.userRenegotiate.pid.trim()!=connection.userid&&"all"!=message.userRenegotiate.pid||isAdmin||(connection.extra.broadcaster&&changeLinksInRoomUrlsPanel("broadcaster",!1,!0),setTimeout(function(){connection.renegotiate(),DEBUG&&console.log("==== userRenegotiate command from Admin ===== ")},Math.floor(1e3*Math.random())+500))}if(message.userJoin){if(!connection.extra.adminEnableStatus)return;connection.extra.broadcaster&&changeLinksInRoomUrlsPanel("broadcaster",!1,!0),DEBUG&&console.info("Command to Join"),message.userJoin.pid.trim()!=connection.userid&&"all"!=message.userJoin.pid||setTimeout(function(){DEBUG&&console.info("Command to Join"),startJoinRoom(),DEBUG&&console.log("==== userJoin command from Admin ===== ")},Math.floor(1e3*Math.random())+500)}if(message.userDeleteFromBackup&&isAdmin){if(!connection.extra.adminEnableStatus)return;var pid=message.userDeleteFromBackup;disableUserParams(pid,userBackup[pid]),userDeleteHandler(pid),delete userBackup[pid],DEBUG&&console.log("==== userDeleteFromBackup from Broadcaster ",message.userDeleteFromBackup,"===== ")}})}function stopCaptureScreenStream(){null!=RMCMediaTrack.screen&&(RMCMediaTrack.screen.stop(),RMCMediaTrack.cameraStream.getVideoTracks()[0].readyState&&(RMCMediaTrack.cameraStream.getVideoTracks().forEach(function(track){RMCMediaTrack.cameraStream.removeTrack(track)}),RMCMediaTrack.cameraStream.addTrack(RMCMediaTrack.cameraVideoTrack),RMCMediaTrack.selfVideo.srcObject=RMCMediaTrack.cameraStream,replaceTrack(RMCMediaTrack.cameraVideoTrack),connection.attachStreams=[RMCMediaTrack.cameraStream]),document.getElementById("share-screen").style.display="",document.getElementById("stop-share-screen").style.display="none",selectRotateVideo.value=selectRotateVideo[0].value,selectRotateVideo.onchange(),RMCMediaTrack.screen=null)}function replaceTrack(videoTrack){videoTrack&&("ended"!==videoTrack.readyState?connection.getAllParticipants().forEach(function(pid){var peer=connection.peers[pid].peer;if(peer.getSenders){var trackToReplace=videoTrack;peer.getSenders().forEach(function(sender){sender&&sender.track&&"video"===sender.track.kind&&trackToReplace&&(sender.replaceTrack(trackToReplace),trackToReplace=null)})}}):DEBUG&&console.log('Can not replace an "ended" track. track.readyState: '+videoTrack.readyState))}function getDisplayMediaError(error){"http:"===location.protocol?showErrorMessage("Please test this WebRTC experiment on HTTPS."):showErrorMessage(error.toString())}function showErrorMessage(error,color){statusHeaderHandler(error,5e3,color=color||"red")}Jungle.prototype.setDelay=function(delayTime){this.modGain1.gain.setTargetAtTime(.5*delayTime,0,.01),this.modGain2.gain.setTargetAtTime(.5*delayTime,0,.01)},Jungle.prototype.setPitchOffset=function(mult){mult>0?(this.mod1Gain.gain.value=0,this.mod2Gain.gain.value=0,this.mod3Gain.gain.value=1,this.mod4Gain.gain.value=1):(this.mod1Gain.gain.value=1,this.mod2Gain.gain.value=1,this.mod3Gain.gain.value=0,this.mod4Gain.gain.value=0),this.setDelay(delayTime*Math.abs(mult))},document.getElementById("share-screen").onclick=function(){RMCMediaTrack.cameraVideoTrack&&function(){if(navigator.getDisplayMedia||navigator.mediaDevices.getDisplayMedia){if(!RMCMediaTrack.cameraVideoTrack)return;function onGettingSteam(screen){var stream,callback;RMCMediaTrack.preRecorededStream&&preRecordedMediaClose.onclick(),replaceTrack(screen.getVideoTracks()[0]),RMCMediaTrack.screen=screen.getVideoTracks()[0],RMCMediaTrack.selfVideo.srcObject=screen,connection.attachStreams.forEach(function(stream){stream.getVideoTracks().forEach(function(track){stream.removeTrack(track)}),stream.addTrack(screen.getVideoTracks()[0])}),callback=function(){DEBUG&&console.log("screensharing has ended"),stopCaptureScreenStream()},(stream=screen).addEventListener("ended",function(){callback(),callback=function(){}},!1),stream.addEventListener("inactive",function(){callback(),callback=function(){}},!1),stream.getTracks().forEach(function(track){track.addEventListener("ended",function(){callback(),callback=function(){}},!1),track.addEventListener("inactive",function(){callback(),callback=function(){}},!1)}),connection.enableLogs&&DEBUG&&console.info("capabilities:\n\n"+JSON.stringify(RMCMediaTrack.screen.getCapabilities(),null,"\t")),document.getElementById("stop-share-screen").style.display="",selectRotateVideo.value=selectRotateVideo[1].value,selectRotateVideo.onchange()}var displayMediaStreamConstraints={video:!Object.keys(selectConstraintsForDisplayMediaStream()).length||selectConstraintsForDisplayMediaStream()};navigator.mediaDevices.getDisplayMedia?navigator.mediaDevices.getDisplayMedia(displayMediaStreamConstraints).then(stream=>{onGettingSteam(stream),document.getElementById("share-screen").style.display="none"}).catch(err=>{getDisplayMediaError(err)}):navigator.getDisplayMedia&&navigator.getDisplayMedia(displayMediaStreamConstraints).then(stream=>{onGettingSteam(stream)}).catch(err=>getDisplayMediaError(err))}else"Chrome"===DetectRTC.browser.name&&(71==DetectRTC.browser.version?showErrorMessage('Please enable "Experimental WebPlatform" flag via chrome://flags.'):DetectRTC.browser.version<71?showErrorMessage("Please upgrade your Chrome browser."):showErrorMessage("Please make sure that you are not using Chrome on iOS.")),"Firefox"===DetectRTC.browser.name&&showErrorMessage("Please upgrade your Firefox browser."),"Edge"===DetectRTC.browser.name&&showErrorMessage("Please upgrade your Edge browser."),"Safari"===DetectRTC.browser.name&&showErrorMessage("Safari does NOT supports getDisplayMedia API yet.")}()},document.getElementById("stop-share-screen").style.display="none",document.getElementById("stop-share-screen").onclick=function(){this.style.display="none",stopCaptureScreenStream()},connection.enableFileSharing=!0,connection.chunkSize=6e4,connection.filesContainer=document.getElementById("file-container"),connection.filesContainer.style="background-color: #FFE0B2;";var clearFileContainerButton=document.createElement("button");clearFileContainerButton.style.display="none",clearFileContainerButton.setAttribute("id","clear-button"),clearFileContainerButton.innerHTML="Clear file container",clearFileContainerButton.setAttribute("onclick","clearFileContainer()"),document.getElementById("share-file").disabled=!1,document.getElementById("share-file").onclick=function(file){0!=connection.getAllParticipants().length&&(new FileSelector).selectSingleFile(function(file){(file||file.size)&&(connection.filesContainer.innerHTML="Wait a bit...",file,connection.getAllParticipants().forEach(function(pid){pid!=connection.userid&&!0!==connection.peers[pid].extra.viewer&&connection.send(file,pid)}))})},connection.onFileProgress=function(chunk){var helper=progressHelper[chunk.remoteUserId];helper.progress.value=chunk.currentPosition||chunk.maxChunks||helper.progress.max,function(progress,label){if(-1==progress.position)return;var position=+progress.position.toFixed(2).split(".")[1]||"---";label.innerHTML=position+"%"}(helper.progress,helper.label)};var progressHelper={};connection.onFileStart=function(file){var div=document.createElement("div");div.id="share-div-box-"+file.remoteUserId+"-"+file.uuid,div.title=file.name,div.className="file-info",connection.userid==file.userid?div.innerHTML="Send to user "+file.remoteUserId+" the file "+file.name+" ("+Math.round(file.size/1e3)+" kbytes) <label>0%</label> <progress></progress>":div.innerHTML="You receive file from user "+file.userid+" the file "+file.name+" ("+Math.round(file.size/1e3)+" kbytes) <label>0%</label> <progress></progress>","none"==clearFileContainerButton.style.display&&(clearFileContainerButton.style.display=""),connection.filesContainer.innerHTML="",connection.filesContainer.appendChild(div),connection.filesContainer.appendChild(clearFileContainerButton),progressHelper[file.remoteUserId]={div:div,progress:div.querySelector("progress"),label:div.querySelector("label")},progressHelper[file.remoteUserId].progress.max=file.maxChunks};var fileStatusBox={};connection.onFileEnd=function(file){if(setTimeout(function(){document.getElementById("share-div-box-"+file.remoteUserId+"-"+file.uuid)&&document.getElementById("share-div-box-"+file.remoteUserId+"-"+file.uuid).remove()},200),!fileStatusBox[file.uuid]){var div=document.createElement("div");if(div.id="preview-div-box-"+file.uuid,div.title=file.name,connection.filesContainer.appendChild(div),fileStatusBox[file.uuid]={div:div},file.remoteUserId!==connection.userid?fileStatusBox[file.uuid].div.innerHTML="<br />You sent the file: ":fileStatusBox[file.uuid].div.innerHTML='<br />Receive from user <span style="color:#f17f5d">'+file.remoteUserId+"</span> the file: ",fileStatusBox[file.uuid].div.innerHTML+='<a href="'+file.url+'" target="_blank" download="'+file.name+'">'+file.name+" ("+bytesToSize(file.size)+') Click to Download</a> || <a href="#" id="file-attachment-delete-'+file.name+'">Delete</a>',(file.name||"").toLowerCase().match(/.webm|.wav|.mp3|.ogg|.flac|.mp4|.avi|.pdf|.txt|.js|.css|.cs|.png|.jpg|.jpeg|.gif/g)){fileStatusBox[file.uuid].div.innerHTML+=' || <a href="#" id="file-attachment-display-on-'+file.name+'">Preview</a><br />';var attachmentDisplayOn=document.getElementById("file-attachment-display-on-"+file.name);attachmentDisplayOn&&attachmentDisplayOn.addEventListener("click",function(e){attachmentDisplayOn.style.display="none",fileStatusBox[file.uuid].div.innerHTML+=function(file){var url,attachment;url=file.url||URL.createObjectURL(file),attachment=-1!=file.type.indexOf("image")?'<br /><img src="'+url+'" title="'+file.name+'" style="max-width: 80%;">':'<br /><iframe src="'+url+'" title="'+file.name+'" style="width: 80%;height: inherit;border: 0;display:block; margin: 0 auto;"></iframe><br />';return attachment}(file),attachmentDelete(file)})}connection.filesContainer.appendChild(clearFileContainerButton),attachmentDelete(file),fileLinksArray.push(file.url),setTimeout(Resize,500)}};var fileLinksArray=[];function attachmentDelete(file){var attachmentElemDelete=document.getElementById("file-attachment-delete-"+file.name);attachmentElemDelete&&attachmentElemDelete.addEventListener("click",function(e){window.URL.revokeObjectURL(file.url),fileStatusBox[file.uuid].div.remove(),function(array,element){const index=array.indexOf(element);array.splice(index,1)}(fileLinksArray,file.url),0==fileLinksArray.length&&(clearFileContainerButton.style.display="none"),setTimeout(Resize,500)})}var preRecordedMedia=document.getElementById("pre-recorded-media"),preRecordedMediaClose=document.getElementById("pre-recorded-media-on");preRecordedMedia.onclick=function(){if(!0,void 0!==connection.attachStreams[0]){var selector=new FileSelector;selector.accept="*.webm",selector.selectSingleFile(function(file){if(file||file.size)if(-1!==file.name.search(/.webm|.wav|.mp3|.ogg|.flac|.mp4/g)){RMCMediaTrack.screen&&stopCaptureScreenStream(),preRecordedMedia.style.display="none",preRecordedMediaClose.style.display="";var video=document.createElement("video"),blobURI=URL.createObjectURL(file);video.src=blobURI+"#t=0",video.loop=!0,video.poster="preload.png",video.muted=!0,video.volume=0,video.play(),RMCMediaTrack.selfVideo.setAttribute("loop",!0),selectRotateVideo.value=selectRotateVideo[1].value,selectRotateVideo.onchange(),setTimeout(function(){try{"captureStream"in video?RMCMediaTrack.preRecorededStream=video.captureStream():"mozCaptureStream"in video?RMCMediaTrack.preRecorededStream=video.mozCaptureStream():"webkitCaptureStream"in video&&(RMCMediaTrack.preRecorededStream=video.webkitCaptureStream())}catch(e){RMCMediaTrack.preRecorededStream=null}RMCMediaTrack.preRecorededStream&&(null!==RMCMediaTrack.cameraVideoTrack?(RMCMediaTrack.preRecorededStream.getAudioTracks()[0]&&(replaceAudioTrack(RMCMediaTrack.preRecorededStream.getAudioTracks()[0]),connection.attachStreams.forEach(function(stream){stream.getAudioTracks().forEach(function(track){stream.removeTrack(track)}),stream.addTrack(RMCMediaTrack.preRecorededStream.getAudioTracks()[0])})),RMCMediaTrack.preRecorededStream.getVideoTracks()[0]&&(replaceTrack(RMCMediaTrack.preRecorededStream.getVideoTracks()[0]),connection.attachStreams.forEach(function(stream){stream.getVideoTracks().forEach(function(track){stream.removeTrack(track)}),stream.addTrack(RMCMediaTrack.preRecorededStream.getVideoTracks()[0])}))):(RMCMediaTrack.selfVideo.srcObject=RMCMediaTrack.preRecorededStream,connection.attachStreams=[RMCMediaTrack.preRecorededStream],setTimeout(function(){RMCMediaTrack.preRecorededStream.getAudioTracks()[0]&&replaceAudioTrack(RMCMediaTrack.preRecorededStream.getAudioTracks()[0]),RMCMediaTrack.preRecorededStream.getVideoTracks()[0]&&replaceTrack(RMCMediaTrack.preRecorededStream.getVideoTracks()[0])},2e3)),void 0!==connection.attachStreams[0]&&(hark(connection.attachStreams[0]).stop(),SpacebarToggleLocalMicrophone(),preRecordedMediaClose.onclick=function(){preRecordedMedia.style.display="",preRecordedMediaClose.style.display="none",statusHeaderHandler(),null!==RMCMediaTrack.cameraVideoTrack?(selectRotateVideo.value=selectRotateVideo[0].value,selectRotateVideo.onchange(),!1,RMCMediaTrack.selfVideo.removeAttribute("loop",!0),RMCMediaTrack.cameraVideoTrack&&(RMCMediaTrack.cameraStream.getVideoTracks().forEach(function(track){RMCMediaTrack.cameraStream.removeTrack(track)}),RMCMediaTrack.cameraStream.addTrack(RMCMediaTrack.cameraVideoTrack),replaceTrack(RMCMediaTrack.cameraVideoTrack)),RMCMediaTrack.cameraStream.getAudioTracks().forEach(function(track){RMCMediaTrack.cameraStream.removeTrack(track)}),RMCMediaTrack.audioHandler?(RMCMediaTrack.cameraStream.addTrack(RMCMediaTrack.audioHandler),replaceAudioTrack(RMCMediaTrack.audioHandler)):(RMCMediaTrack.cameraStream.addTrack(RMCMediaTrack.cameraAudioTrack),replaceAudioTrack(RMCMediaTrack.cameraAudioTrack)),connection.attachStreams=[RMCMediaTrack.cameraStream]):(RMCMediaTrack.selfVideo.srcObject=RMCMediaTrack.cameraStream,RMCMediaTrack.audioHandler?(stopAudioHandling(),setTimeout(function(){startAudioHandling(),RMCMediaTrack.cameraStream.addTrack(RMCMediaTrack.audioHandler),replaceAudioTrack(RMCMediaTrack.audioHandler)},1e3)):(RMCMediaTrack.cameraStream.addTrack(RMCMediaTrack.cameraAudioTrack),replaceAudioTrack(RMCMediaTrack.cameraAudioTrack),connection.attachStreams=[RMCMediaTrack.cameraStream])),setTimeout(function(){RMCMediaTrack.preRecorededStream.getTracks().forEach(track=>track.stop()),RMCMediaTrack.preRecorededStream=null,startHark()},1e3),window.URL.revokeObjectURL(file)}))},2e3)}else alert("Please select either .webm, .wav, .mp3, .ogg, .flac or .mp4 file.")})}};const scriptCanvasDesignerWidget=document.createElement("script");scriptCanvasDesignerWidget.src="/dist/canvas-designer/canvas-designer-widget.js",scriptCanvasDesignerWidget.defer=!0,document.body.appendChild(scriptCanvasDesignerWidget),document.getElementById("draw").onclick=function(){0!=connection.streamEvents.selectAll().length&&(this.style.display="none",document.getElementById("stop-draw").style.display="",function(){if(0==connection.streamEvents.selectAll().length)return;if(isView||isAdmin)return;drawContainer.style.display="",designer||((linkToImage=document.createElement("a")).id="link-to-download-draw-image",linkToImage.style="background-color:antiquewhite;",linkToImage.target="_blank",linkToImage.download="image.png",linkToImage.innerHTML="Click to Download Image",drawContainer.appendChild(linkToImage),(designer=new CanvasDesigner).widgetHtmlURL="/dist/canvas-designer/widget.html",designer.widgetJsURL="/dist/canvas-designer/widget.js",designer.setSelected("pencil"),designer.setTools({pencil:!0,colorsPicker:!0,text:!0,image:!0,pdf:!0,eraser:!0,line:!0,arrow:!0,dragSingle:!0,dragMultiple:!0,arc:!0,rectangle:!0,quadratic:!0,bezier:!1,marker:!0,zoom:!1,lineWidth:!0,extraOptions:!1,code:!1,undo:!0}),designer.appendTo(drawContainer));drawContainer.style="border: 1px solid orange; margin: auto;",designer.iframe.style.width=drawContainer.style.width=Math.round(document.getElementById("videos-container").clientWidth)+"px",designer.iframe.style.height=drawContainer.style.height=Math.round(document.getElementById("videos-container").clientHeight/1.5-linkToImage.clientHeight)+"px",Resize(),getDataURL(),designer&&designer.pointsLength<=0&&setTimeout(function(){connection.send("plz-sync-points")},1e3);designer.addSyncListener(function(data){connection.send({designerMessage:data}),getDataURL()})}())},document.getElementById("stop-draw").style.display="none",document.getElementById("stop-draw").onclick=function(){this.style.display="none",document.getElementById("draw").style.display="",function(){if(0==connection.streamEvents.selectAll().length)return;if(!designer)return;DEBUG&&console.log("stopDraw"),designer.destroy(),designer=null,linkToImage.href="",linkToImage.innerHTML="",drawContainer.style.display="none",Resize()}()};var designer,linkToImage,drawContainer=document.getElementById("draw-container");function getDataURL(){designer.toDataURL("image/png",function(dataURL){linkToImage.href=dataURL})}const enableRecordVideo="true"===siteConfigEnableForViewersToRecordVideo;var recordingDuration,recordUI,recordingStatus,btnStopRecording,timeoutRecordingStatusHandling,timeStartRecord,timeNowRecord,timeTotalRecord;function stopRecordHandler(){if(isView)return connection.recorder?void connection.recorder.stopRecording(function(blobURL){getSeekableBlob(connection.recorder.getBlob(),function(seekableBlob){var fileName="DDTalk-video-"+connection.token()+" Size "+bytesToSize(seekableBlob.size).toString().replace(".",",")+" Time "+timeFormat(timeTotalRecord).toString().replace(":","-")+".mp4";invokeSaveAsDialog(seekableBlob,fileName),DEBUG&&console.log("file",fileName," is download. Play mp4 in VLC player")}),timeoutRecordingStatusHandling&&clearTimeout(timeoutRecordingStatusHandling),connection.recorder.clearRecordedData(),window.URL.revokeObjectURL(blobURL),connection.recorder.streams=[],connection.recorder=null,btnStopRecording.style.display="none",recordingStatus.style.display="none",btnStopRecording.removeAttribute("onclick"),recordUI.remove(),connection.filesContainer.querySelectorAll("video")[0].srcObject=null,connection.filesContainer.querySelectorAll("video")[0].remove(),connection.filesContainer.innerHTML="",connection.filesContainer.style="",document.getElementById("record-off").style.display="",document.getElementById("record-on").style.display="none",setTimeout(Resize,500)}):alert("No recorder found.")}function resetVideoStreamsForRecorder(endedStream){if(isView&&connection.recorder){var i=0;Object.values(connection.recorder.streams).forEach(function(e){e.streamid==endedStream&&(connection.recorder.streams.splice(i,1),DEBUG&&console.log("remove connection.recorder.streams[",i,"] = ",e.streamid)),i++}),setTimeout(function(){var arrayOfMediaStreams=[];connection.streamEvents.selectAll({remote:!0}).forEach(function(e){e.streamid!=endedStream&&e.mediaElement&&arrayOfMediaStreams.push(e.stream)}),DEBUG&&console.log("***resetVideoStreams: new streams array for record \n",arrayOfMediaStreams),connection.recorder.getInternalRecorder().resetVideoStreams(arrayOfMediaStreams)},1e3)}}!0===isView&&!0===enableRecordVideo&&function checkAdminEnableStatus(){1==enableAdmins&&!0===enableRecordVideo?("undefined"==typeof RecordRTC&&(function(){if(!isView&&!enableRecordVideo)return;var scriptRecordRTC=document.createElement("script");scriptRecordRTC.src="/dist/RecordRTC.min.js",scriptRecordRTC.defer=!0,document.body.appendChild(scriptRecordRTC);var scriptSeekableWebM=document.createElement("script");scriptSeekableWebM.src="/dist/EBML.min.js",scriptSeekableWebM.defer=!0,document.body.appendChild(scriptSeekableWebM)}(),function(){if(!isView&&!enableRecordVideo)return;if(document.getElementById("record-off"))return;var recordIconOffUI=document.createElement("label");recordIconOffUI.innerHTML='<label><img id="record-off" src="record-off.png" class="icon-menu" title="Start Record" />';var recordIconOnUI=document.createElement("label");recordIconOnUI.innerHTML='<label><img id="record-on" src="record-on.png" class="icon-menu" style="display: none;" title="Stop Record" />',document.getElementById("menu").appendChild(recordIconOffUI),document.getElementById("menu").appendChild(recordIconOnUI),document.getElementById("record-off").onclick=function(){0!=connection.streamEvents.selectAll().length&&connection.extra.adminEnableStatus&&((isView||enableRecordVideo)&&enableAdmins&&0!=connection.streamEvents.selectAll().length&&((recordUI=document.createElement("div")).setAttribute("id","record-container"),recordUI.innerHTML='<span id="recording-status" style="display: none;"></span><button id="btn-stop-recording" style="display: none;">Stop Recording</button><br /><br />',connection.filesContainer.appendChild(recordUI),recordingStatus=document.getElementById("recording-status"),(btnStopRecording=document.getElementById("btn-stop-recording")).style.display="inline-block",recordingStatus.style.display="inline-block",timeStartRecord=+new Date,function recordingStatusHandling(){connection.streamEvents.selectAll({remote:!0}).forEach(function(event){if(connection.recorder||document.getElementById("record-preview")){if(connection.recorder&&0==connection.recorder.streams.some(function(e){return e==event.stream})){if(!event.mediaElement)return;connection.recorder.streams.push(event.stream),connection.recorder.getInternalRecorder().addStreams([event.stream]),DEBUG&&console.log("add stream to record",event.stream)}}else DEBUG&&console.log("RecordRTC",event),connection.recorder=RecordRTC([event.stream],{mimeType:"video/webm;codecs=h264",fileExtension:"mp4",type:"video",disableLogs:DEBUG,timeSlice:1e3,onTimeStamp:function(timestamp){timeNowRecord=timestamp},video:{width:640,height:360},previewStream:function(stream){if(!document.getElementById("record-preview")){connection.filesContainer.setAttribute("style","font-size:0;background-color: rgb(255, 224, 178);padding: 3px;");var pUI=document.createElement("p");pUI.style="position: absolute; color: #FFF3E0; background-color: #424242; font-size: 1.5vw; padding: 0; margin: 0; text-align: center; border: 0; z-index: 1; word-wrap: break-word; white-space: pre-wrap;",pUI.innerHTML="Preview record video";var video=document.createElement("video");video.setAttribute("autoplay",!0),video.setAttribute("playsinline",!0),video.setAttribute("poster",!0),video.setAttribute("controls",!0),video.setAttribute("style",!0),video.poster="preload.png",video.id="record-preview",video.muted=!0,video.srcObject=stream,video.tabIndex=0,video.focus(),video.play(),connection.filesContainer.appendChild(pUI),connection.filesContainer.appendChild(video)}}}),recordingDuration=864e5,connection.recorder.setRecordingDuration(recordingDuration).onRecordingStopped(function(){document.getElementById("record-on").onclick()}),connection.recorder.startRecording(),connection.recorder.streams||(connection.recorder.streams=[],connection.recorder.streams.push(event.stream))});var videoElement=connection.filesContainer.querySelectorAll("video")[0];videoElement.style.height=videoElement.style.maxHeight="100px",setTimeout(Resize,500),timeTotalRecord=Math.floor(-1*(timeStartRecord-timeNowRecord)/1e3),recordingStatus.innerHTML="Status: "+connection.recorder.state+" ",btnStopRecording.innerHTML=timeFormat(timeTotalRecord)+" || Stop Recording",timeoutRecordingStatusHandling=setTimeout(recordingStatusHandling,1e3)}(),btnStopRecording.onclick=function(){stopRecordHandler()}),Resize(),document.getElementById("record-off").style.display="none",document.getElementById("record-on").style.display="")},document.getElementById("record-on").onclick=function(){stopRecordHandler(),document.getElementById("record-off").style.display="",document.getElementById("record-on").style.display="none"},"true"==params.record==1&&setTimeout(function(){document.getElementById("record-off").onclick()},5e3)}()),connection.recorder?(document.getElementById("record-off").style.display="none",document.getElementById("record-on").style.display=""):(document.getElementById("record-off").style.display="",document.getElementById("record-on").style.display="none")):"undefined"!=typeof RecordRTC&&(document.getElementById("record-off").style.display="none",document.getElementById("record-on").style.display="none",connection.recorder&&document.getElementById("record-on").onclick());setTimeout(checkAdminEnableStatus,2e3)}()}();